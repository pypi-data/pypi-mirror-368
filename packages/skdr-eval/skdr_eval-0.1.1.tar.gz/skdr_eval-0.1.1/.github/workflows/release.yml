name: Release

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools_scm

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        twine check dist/*

    - name: Publish to PyPI (Trusted Publishing)
      id: pypi-publish
      continue-on-error: true
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true

    - name: Fallback - Manual PyPI publish instructions
      if: steps.pypi-publish.outcome == 'failure'
      run: |
        echo "‚ùå Trusted Publishing failed. Manual upload required."
        echo ""
        echo "To publish manually:"
        echo "1. Download the build artifacts from this workflow"
        echo "2. Set up your PyPI API token: https://pypi.org/manage/account/token/"
        echo "3. Run: pip install twine"
        echo "4. Run: twine upload dist/*"
        echo ""
        echo "For Trusted Publishing setup:"
        echo "1. Go to https://pypi.org/manage/project/skdr-eval/settings/publishing/"
        echo "2. Add this GitHub repository as a trusted publisher"
        echo "3. Set environment name to 'release'"
        echo "4. Set workflow filename to 'release.yml'"
        echo ""
        exit 1

    - name: Upload build artifacts (for manual fallback)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ github.run_number }}
        path: dist/
