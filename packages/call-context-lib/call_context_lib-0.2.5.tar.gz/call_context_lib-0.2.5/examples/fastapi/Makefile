# Default target
.PHONY: all
all: lint format lock test

# WORKERS
WORKERS ?= 1

# Port
PORT ?= 8000

# Tools
PYTEST = pytest
DDTRACE   := ddtrace-run
UVICORN  := uvicorn

# Directories
SRC = $(CURDIR)
TESTS = tests


# Install dependencies
.PHONY: install
install:
	@echo 'Installing project dependencies...'
	uv pip install -e .


# Install production dependencies (venv + pip install . + uv ì„¤ì¹˜)
.PHONY: install-deploy
install-deploy:
	@echo 'ğŸ“¦ Installing production dependencies...'
	uv venv
	uv pip install .
	uv pip install uv

# Lint
.PHONY: lint
lint:
	@echo 'ğŸ§ª Running linter...'
	uv run ruff check $(SRC) || true
	@echo ' ======================== '
	@echo 'ğŸ§ª Running signature check...'
	uv run mypy $(SRC) || true

# Format
.PHONY: format
format:
	@echo 'ğŸ§ª Running formater...'
	uv run ruff format .

# Run tests
.PHONY: test
test:
	@echo 'Running tests...'
	@if [ -d "$(TESTS)" ]; then \
		PYTHONPATH=../../libs/call_context_lib .venv/bin/python -m pytest -p no:pdb $(TESTS); \
	else \
		echo "No tests directory found, skipping tests..."; \
	fi

# Generate coverage report (tests run under coverage)
.PHONY: coverage
coverage:
	@echo "ğŸ›¡ï¸ Generating coverage report..."
	@if [ -d "$(TESTS)" ]; then \
		uv run coverage run -m pytest -p no:pdb $(TESTS) || true; \
		uv run coverage xml -o coverage.xml; \
		echo "Coverage XML written to coverage.xml"; \
	else \
		echo "No tests directory found, skipping coverage..."; \
	fi

# Lock dependencies
.PHONY: lock
lock:
	@echo 'Updating dependencies and generating lock file...'
	uv lock --upgrade

# Sync dependencies
.PHONY: sync
sync:
	@echo "ğŸ“ CWD: $(shell pwd)"
	@echo "ğŸ“¦ Checking pyproject.toml and uv.lock..."
	@ls -l pyproject.toml uv.lock 2>/dev/null || echo "âŒ Required files missing!"
	@echo 'ğŸ”„ Syncing dependencies from lock file...'
	uv sync

.PHONY: sync-dev
sync-dev:
	@echo "ğŸ”„ Syncing dev dependencies in: $(shell pwd)"
	@echo "ğŸ“¦ Checking pyproject.toml and uv.lock..."
	@ls -l pyproject.toml uv.lock 2>/dev/null || echo "âŒ Required files missing!"
	@echo 'ğŸ”„ Syncing dependencies from lock file...'
	@uv venv
	@uv pip install --upgrade pip
	@uv sync --dev


# Run the application
.PHONY: run
run:
	@echo 'Starting API server...'
	@if [ -f .env ]; then \
		export $(shell cat .env | xargs); \
	fi
	uv run $(UVICORN) main:app \
		--host 0.0.0.0 \
		--port $(PORT)

# Help
.PHONY: help
help:
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo "  all         : lint, format, lock, testë¥¼ ëª¨ë‘ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  install     : í”„ë¡œì íŠ¸ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤."
	@echo "  install-deploy  : ë°°í¬ìš© ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤."
	@echo "  lint        : ruffì™€ mypyë¥¼ ì‚¬ìš©í•˜ì—¬ ì½”ë“œë¥¼ ë¦°íŠ¸í•©ë‹ˆë‹¤."
	@echo "  format      : ruffë¥¼ ì‚¬ìš©í•˜ì—¬ ì½”ë“œ í˜•ì‹ì„ ë§ì¶¥ë‹ˆë‹¤."
	@echo "  test        : pytestë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  coverage    : í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
	@echo "  lock        : ì˜ì¡´ì„±ì„ ì—…ê·¸ë ˆì´ë“œí•˜ê³  lock íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤."
	@echo "  sync        : lock íŒŒì¼ë¡œë¶€í„° ì˜ì¡´ì„±ì„ ë™ê¸°í™”í•©ë‹ˆë‹¤."
	@echo "  sync-dev    : ê°œë°œìš© ì˜ì¡´ì„±ì„ í¬í•¨í•˜ì—¬ ë™ê¸°í™”í•©ë‹ˆë‹¤."
	@echo "  run   : Local ì—ì„œ .env íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ API ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  help        : ì´ ë„ì›€ë§ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤."