<html>
<head>
    <script type="text/javascript">{{{ files.dygraphs_js }}}</script>
    <script type="text/javascript">{{{ files.dygraphs_crosshair_js }}}</script>
    <script type="text/javascript">{{{ files.dygraphs_synchronizer_js }}}</script>
    <style type="text/css">{{{ files.dygraphs_css }}}</style>
    <script type="text/javascript">{{{ files.helpers_js }}}</script>
    <style type="text/css">{{{ files.custom_css }}}</style>
</head>
<body>
    <div style="display: flex; gap: 1rem;">
        <div id="server" class="section" style="flex: 0.6;">
            <h1>
                <div class="header-icon">
                    {{{ files.icon_motherboard }}}
                </div>
                <div class="header-text">
                    <div class="title">Server</div>
                    <p class="description">Key hardware specifications of the hosting server.</p>
                </div>
            </h1>
            <div class="section-content">
                <div class="section-content-cards">
                    <div class="section-content-card">
                        <div class="section-content-card-label">OS family</div>
                        <div class="section-content-card-value">{{{ server_info.os }}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">
                            Allocation
                            <span class="info-icon">
                                {{{ files.icon_info }}}
                                <div class="tooltip-content">
                                    Indicates whether this server appears to be dedicated to this process or shared with other processes. This assessment is based on comparing system-level resource usage with process-specific resource usage, analyzing patterns in CPU, memory, GPU, and VRAM utilization against both percentage thresholds and absolute values.
                                </div>
                            </span>
                        </div>
                        <div class="section-content-card-value">{{{ server_info.allocation }}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">vCPUs</div>
                        <div class="section-content-card-value">{{{ server_info.vcpus }}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">Memory</div>
                        <div class="section-content-card-value">{{{ server_info.memory_mb | pretty_number }}} MiB</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">Storage</div>
                        <div class="section-content-card-value">{{{ system_metrics.disk_space_total_gb | index:0 | pretty_number }}} GiB</div>
                    </div>
                    {{ #if server_info.gpu_names }}
                    <div class="section-content-card">
                        <div class="section-content-card-label">GPUs</div>
                        <div class="section-content-card-value">{{{ server_info.gpu_count }}} {{{ server_info.gpu_name }}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">VRAM</div>
                        <div class="section-content-card-value">{{{server_info.gpu_memory_mb | pretty_number }}} MiB</div>
                    </div>
                    {{ /if }}
                </div>
            </div>
        </div>
        <div id="provider" class="section" style="flex: 0.4;">
            <h1>
                <div class="header-icon">
                    {{{ files.icon_clouds }}}
                </div>
                <div class="header-text">
                    <div class="title">Cloud</div>
                    <p class="description">Network discovery indicates the following cloud environment was utilized for this step.</p>
                </div>
            </h1>
            <div class="section-content">
                <div class="section-content-cards">
                    <div class="section-content-card">
                        <div class="section-content-card-label">Cloud Provider</div>
                        <div class="section-content-card-value">{{{ cloud_info.vendor }}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">Region/Datacenter</div>
                        <div class="section-content-card-value">{{{ cloud_info.region }}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">Instance Type</div>
                        <div class="section-content-card-value">
                        {{ #if cloud_info.compute_costs }}
                            <a href="https://sparecores.com/server/{{{cloud_info.vendor}}}/{{{cloud_info.instance_type}}}" target="_blank" style="color: #34D399;">{{{ cloud_info.instance_type }}} {{{ files.icon_external_link }}}</a>
                        {{ #else }}
                            {{{ cloud_info.instance_type }}}
                        {{ /if }}
                        </div>
                    </div>
                    {{ #if cloud_info.compute_costs }}
                    <div class="section-content-card">
                        <div class="section-content-card-label">
                            Compute Costs
                            <span class="info-icon">
                                {{{ files.icon_info }}}
                                <div class="tooltip-content">
                                    The cost of running this cloud server for the duration of this step, not including storage, network traffic, IPV4 prices, startup time or any discounts.
                                </div>
                            </span>
                        </div>
                        <div class="section-content-card-value">${{{cloud_info.compute_costs}}}</div>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
    <div style="display: flex; gap: 1rem;">
        <div id="stats" class="section" style="flex: 0.6;">
            <h1>
                <div class="header-icon">
                    {{{ files.icon_calculator }}}
                </div>
                <div class="header-text">
                    <div class="title">Usage Statistics</div>
                    <p class="description">Current and historical (including up-to the last five successful runs) averages, peaks and other summaries on resource usage.</p>
                </div>
            </h1>
            <div class="section-content">
                <div class="section-content-cards">
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">CPU</div>
                        <div class="section-content-card-value">
                            <span class="metric-highlight">{{{ stats.process_cpu_usage.mean }}}</span> avg
                            <span class="metric-separator">|</span>
                            <span class="metric">{{ #if historical_stats }}{{{ combined_stats.process_cpu_usage.mean }}}{{ #else }}-{{/if}}</span> hist avg
                            <span class="metric-separator">|</span>
                            <span class="metric">{{ #if historical_stats }}{{{ combined_stats.process_cpu_usage.max }}}{{ #else }}-{{/if}}</span> peak</div>
                    </div>
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">Memory</div>
                        <div class="section-content-card-value">
                            <span class="metric">{{{stats.process_memory.mean | divide:1024 | pretty_number:2 }}} MiB</span> avg
                            <span class="metric-separator">|</span>
                            <span class="metric">{{{stats.process_memory.max | divide:1024 | pretty_number:2 }}} MiB</span> peak
                            <span class="metric-separator">|</span>
                            <span class="metric-highlight">{{ #if historical_stats }}{{{ combined_stats.process_memory.max | divide:1024 | pretty_number:2 }}}{{ #else }}-{{/if}} MiB</span> hist peak</div>
                    </div>
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">Duration</div>
                        <div class="section-content-card-value">{{{ resource_tracker.duration | round:2 }}} sec</div>
                    </div>
                    {{ #if status_failed }}
                    <div class="section-content-card-failed">
                    {{ #else }}
                    {{ #if resource_tracker.stopped }}
                    <div class="section-content-card-task">
                    {{ #else }}
                    <div class="section-content-card-failed">
                    {{ /if }}
                    {{ /if }}
                        <div class="section-content-card-label">Status</div>
                        <div class="section-content-card-value">
                            {{ #if status_failed }}
                            Failed
                            <span class="info-icon" style="padding-bottom: 3px;">
                                {{{ files.icon_info }}}
                                <div class="tooltip-content">
                                    The process did not complete successfully, so the collected resource usage data is at least incomplete, but potentially also incorrect. Handle with care!
                                </div>
                            </span>
                            {{ #else }}
                                {{ #if resource_tracker.stopped }}
                                Finished
                                {{ #else }}
                                Pending
                                <span class="info-icon" style="padding-bottom: 3px;">
                                    {{{ files.icon_info }}}
                                    <div class="tooltip-content">
                                        The resource tracker was not stopped properly yet, so the collected resource usage data might be incomplete. Handle with care!
                                    </div>
                                </span>
                                {{ /if }}
                            {{ /if }}
                        </div>
                    </div>
                    {{ #if server_info.gpu_names }}
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">GPU</div>
                        <div class="section-content-card-value">
                            <span class="metric"></span>{{{ stats.process_gpu_usage.mean }}}</span> avg
                            <span class="metric-separator">|</span>
                            <span class="metric">
                                {{ #if historical_stats }}{{{ combined_stats.process_gpu_usage.max }}}{{ #else }}-{{/if}}
                            </span> hist avg
                            <span class="metric-separator">|</span>
                            <span class="metric">{{ stats.process_gpu_usage.max }}</span> peak</div>
                    </div>
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">VRAM</div>
                        <div class="section-content-card-value">
                            <span class="metric">{{{ stats.process_gpu_vram.mean | pretty_number:2 }}} MiB</span> avg
                            <span class="metric-separator">|</span>
                            <span class="metric">{{{ stats.process_gpu_vram.max | pretty_number:2 }}} MiB</span> peak
                            <span class="metric-separator">|</span>
                            <span class="metric-highlight">
                                {{ #if historical_stats }}{{{ combined_stats.process_gpu_vram.max | pretty_number:2 }}}{{ #else }}-{{/if}} MiB
                            </span> hist peak</div>
                    </div>
                    {{ /if }}
                    <div class="section-content-card">
                        <div class="section-content-card-label">Disk Space</div>
                        <div class="section-content-card-value">
                            <span class="metric">{{{ stats.system_disk_space_used_gb.max | pretty_number }}} GiB</span> peak
                        </div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">Traffic</div>
                        <div class="section-content-card-value">
                            <span class="metric">{{{ stats.system_net_recv_bytes.sum | divide:1073741824 | pretty_number:2 }}} GB</span> in
                            <span class="metric-separator">|</span>
                            <span class="metric">{{{ stats.system_net_sent_bytes.sum | divide:1073741824 | pretty_number:2 }}} GB</span> out
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="recommendations" class="section" style="flex: 0.4;">
            <h1>
                <div class="header-icon">
                    {{{ files.icon_robot }}}
                </div>
                <div class="header-text">
                    <div class="title">Recommendations</div>
                    <p class="description">Based on recent average CPU usage, historical peak memory and GPU utilization.</p>
                </div>
            </h1>
            <div class="section-content">
                <div class="section-content-cards">
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">
                            Recommended Resources for Next Run
                            {{ #if resource_tracker.integration_is.metaflow }}
                            <span class="info-icon">
                                {{{ files.icon_info }}}
                                <div class="tooltip-content">
                                    The Metaflow <code>@resources</code> decorator is limited to specifying the number of vCPUs, memory, and number of GPUs, so e.g. no way to specify the minimum amount of VRAM.
                                </div>
                            </span>
                            {{ /if }}
                        </div>
                        <div class="section-content-card-value">
                            {{ #if resource_tracker.integration_is.standalone }}
                            {{ recommended_resources.cpu }} vCPUs, {{ recommended_resources.memory }} MiB memory{{ #if recommended_resources.gpu }}, {{ recommended_resources.gpu }} GPUs with {{ recommended_resources.vram }} MiB VRAM{{ /if }}
                            {{ /if }}
                            {{ #if resource_tracker.integration_is.metaflow }}
                            @resources(cpu={{ recommended_resources.cpu }}, memory={{recommended_resources.memory}}{{ #if recommended_resources.gpu }}, gpu={{ recommended_resources.gpu }}{{ /if }})
                            {{ /if }}
                        </div>
                    </div>
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">Automated Tuning of Resources</div>
                        <div class="section-content-card-value">
                            Learn more at <a href="https://sparecores.com/feedback/metaflow-resource-tracker" target="_blank" style="color: #34D399;">sparecores.com {{{ files.icon_external_link }}}</a>
                        </div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">
                            Cheapest Cloud Server to Run This Step
                            <span class="info-icon">
                                {{{ files.icon_info }}}
                                <div class="tooltip-content">
                                    Evaluated 2000+ servers options accross AWS, GCP, Azure, Hetzner and UpCloud by filtering for the required number of vCPUs, memory, GPUs and min VRAM, then ordered descending by ondemand price, and selected the first one. The price per execution is based on the current best ondemand price of the server and the current duration of the step, and does not include any storage, network traffic, IPV4 prices, the startup time or any discounts. If interested in more advanced recommendations, please get in touch!
                                </div>
                            </span>
                        </div>
                        <div class="section-content-card-value">
                            <ol class="recommended-cloud-servers">
                                <li>
                                    <a href="https://sparecores.com/server/{{{ recommended_server.vendor_id }}}/{{{ recommended_server.api_reference }}}" target="_blank">
                                        <img src="https://sparecores.com/assets/images/vendors/{{{ recommended_server.vendor_id }}}.svg">
                                        <span class="linklike">{{{ recommended_server.display_name }}} {{{ files.icon_external_link }}}</span>
                                        <span style="font-weight: normal;">for ${{{ recommended_server.best_ondemand_price_duration | pretty_number:6 }}}/execution</span>
                                    </a>
                                </li>
                            </ol>
                        </div>
                    </div>
                    {{ #if recommended_server.cost_savings.percent }}
                    <div class="section-content-card">
                        <div class="section-content-card-label">
                            Potential Cost Savings
                            <span class="info-icon">
                                {{{ files.icon_info }}}
                                <div class="tooltip-content">
                                    This calculation assumes the current cloud server is dedicated to running this step and that the recommended cloud server would provide comparable performance. Savings are based on the best available on-demand pricing in supported regions and don't account for any existing discounts you may have.
                                </div>
                            </span>
                        </div>
                        <div class="section-content-card-value">
                            <span class="metric-highlight">
                                {{{ recommended_server.cost_savings.percent }}}%
                            </span>
                            <span class="metric-separator">|</span>
                            <span class="metric">
                                ${{{ recommended_server.cost_savings.amount }}}/execution
                            </span>
                        </div>
                    </div>
                    {{ /if }}
                </div>
            </div>
        </div>
    </div>
    <div id="cpu" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{ files.icon_cpu }}}
            </div>
            <div class="header-text">
                <div class="title">CPU Usage</div>
                <p class="description">CPU usage for both the system and specific processes are calculated by summing user+nice and system CPU times (in clock ticks), normalized by dividing by the total elapsed time and ticks per second. Process CPU usage encompasses all child processes.</p>
            </div>
            <div id="labels_cpu" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_cpu" class="plot"></div>
        </div>
    </div>
    <div id="mem" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{ files.icon_memory }}}
            </div>
            <div class="header-text">
                <div class="title">Memory Usage</div>
                <p class="description">On Linux, the used server memory is calculated by <code>total - free - buffers - cached</code>, while it depends on <code>psutil</code> for other systems. The process memory usage is measured by summing PSS (on Linux), USS (on MacOS and Windows), or RSS rollups of all subprocesses.</p>
            </div>
            <div id="labels_mem" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_mem" class="plot"></div>
        </div>
    </div>
    <div id="disk" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{ files.icon_disk }}}
            </div>
            <div class="header-text">
                <div class="title">Disk I/O Usage</div>
                <p class="description">Process-specific disk usage tracking is unreliable; therefore, it is recommended to monitor disk usage at the system level, encompassing all mounted disks.</p>
            </div>
            <div id="labels_disk" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_disk" class="plot"></div>
        </div>
    </div>
    <div id="disk_space" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{ files.icon_disk }}}
            </div>
            <div class="header-text">
                <div class="title">Disk Space Usage</div>
                <p class="description">System-level disk space usage on all mounted disks.</p>
            </div>
            <div id="labels_disk_space" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_disk_space" class="plot"></div>
        </div>
    </div>
    <div id="net" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{ files.icon_router }}}
            </div>
            <div class="header-text">
                <div class="title">Network Usage</div>
                <p class="description">Network usage is monitored solely at the system level across all interfaces.</p>
            </div>
            <div id="labels_net" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_net" class="plot"></div>
        </div>
    </div>
    {{ #if server_info.gpu_names }}
    <div id="gpu_usage" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{ files.icon_gpu }}}
            </div>
            <div class="header-text">
                <div class="title">GPU Usage</div>
                <p class="description"><code>nvidia-smi</code> reported ratios standardized between 0 and GPU count, proxying how many GPUs have been 100% utilized. Note that process-specific GPU usage is not as reliable as system-level GPU usage and limited up to 4 GPUs.</p>
            </div>
            <div id="labels_gpu_usage" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_gpu_usage" class="plot"></div>
        </div>
    </div>
    <div id="gpu_utilized" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{ files.icon_gpu }}}
            </div>
            <div class="header-text">
                <div class="title">GPUs in Use</div>
                <p class="description"><code>nvidia-smi</code> reported number of GPUs with a utilization greater than 0. Note that process-specific GPU usage is not as reliable as system-level GPU usage and limited up to 4 GPUs.</p>
            </div>
            <div id="labels_gpu_utilized" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_gpu_utilized" class="plot"></div>
        </div>
    </div>
    <div id="gpu_vram" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{ files.icon_gpu }}}
            </div>
            <div class="header-text">
                <div class="title">VRAM Usage</div>
                <p class="description"><code>nvidia-smi</code> reported, summed up VRAM usage for all GPUs. Note that process-specific GPU usage is not as reliable as system-level GPU usage and limited up to 4 GPUs.</p>
            </div>
            <div id="labels_gpu_vram" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_gpu_vram" class="plot"></div>
        </div>
    </div>
    {{ /if }}
    <div id="footer">
        <p>
            Generated by <a href="https://sparecores.github.io/resource-tracker/#metaflow-integration" target="_blank" style="color: #34D399;">resource-tracker v{{ resource_tracker.version }} {{{ files.icon_external_link }}}</a>{{ #if resource_tracker.integration_is.not_standalone }} from <code>{{ resource_tracker.integration }}</code>{{ /if }} using <code>{{ resource_tracker.implementation }}</code> at {{ resource_tracker.report_time | unix_timestamp_to_local_tz_string }}.
        </p>
    </div>
    <script type="text/javascript">
        Dygraph.onDOMready(function onDOMready() {
            var cpuGraph = createGraph("plot_cpu", `{{{ csv.cpu }}}`, 'labels_cpu'),
                memGraph = createGraph("plot_mem", `{{{ csv.mem }}}`, 'labels_mem', { labelsKMG2: true }),
                diskGraph = createGraph("plot_disk", `{{{ csv.disk }}}`, 'labels_disk',
                    {
                        labelsKMG2: true,
                        series: {
                            "Process disk write": {strokePattern: [7, 3], color: '#34D399'},
                            "System disk write": {strokePattern: [7, 3], color: '#38BDF8'},
                            "Process disk read": {strokePattern: null, color: '#34D399'},
                            "System disk read": {strokePattern: null, color: '#38BDF8'}
                        },
                    }),
                diskSpaceGraph = createGraph("plot_disk_space", `{{{ csv.disk_space }}}`, 'labels_disk_space',
                    {
                        labelsKMG2: true,
                        color: '#38BDF8',
                        valueRange: [null, null],
                    }),
                netGraph = createGraph("plot_net", `{{{ csv.net }}}`, 'labels_net',
                    {
                        labelsKMG2: true,
                        series: {
                            "Inbound network traffic": {strokePattern: null, color: '#38BDF8'},
                            "Outbound network traffic": {strokePattern: [7, 3], color: '#38BDF8'},
                        },
                    });
            {{ #if server_info.gpu_names }}
            var gpuUsageGraph = createGraph("plot_gpu_usage", `{{{ csv.gpu_usage }}}`, 'labels_gpu_usage'),
                gpuUtilizedGraph = createGraph("plot_gpu_utilized", `{{{ csv.gpu_utilized }}}`, 'labels_gpu_utilized'),
                gpuVramGraph = createGraph("plot_gpu_vram", `{{{ csv.gpu_vram }}}`, 'labels_gpu_vram', { labelsKMG2: true });
            {{ /if }}
            var sync = Dygraph.synchronize([
                cpuGraph, memGraph, diskGraph, netGraph,
                {{ #if server_info.gpu_names }}
                gpuUsageGraph, gpuUtilizedGraph, gpuVramGraph,
                {{ /if }}
            ], {zoom: true, selection: true, range: false});
        });
    </script>
</body>
</html>