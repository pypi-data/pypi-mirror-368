"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[4176],{44176:(e,t,a)=>{a.r(t),a.d(t,{default:()=>S});var n=a(74389),o=a(90147),s=a(31529),i=a(93345),r=a(95889),l=a(51951),u=a(10997),d=a(87179),c=a(47695),y=a(98696);function m(e){return e.substring(5,e.length-1).split(",")}var p=a(28182),x=a(56087),f=a(76747),h=a(34683),g=a(74667),C=a(33349);const v=e=>{const{formatMessage:t}=(0,r.useIntl)(),{onOk:a,onCancel:o,templatedName:s}=e,[l,u]=(0,i.useState)(""),[d,c]=(0,i.useState)(""),y=(e=>{const t=e.indexOf("$"),a=e.lastIndexOf("$");return e.substring(t,a+1)})(s),m=s.replace(y,l);return(0,n.FD)("div",{style:{width:400,display:"flex",flexDirection:"column"},children:[(0,n.FD)("div",{style:{flexGrow:1,marginBottom:8},children:[(0,n.Y)(g.Input,{style:{marginTop:4},placeholder:y,value:l,onChange:e=>u(e.target.value)}),(0,n.Y)(g.Input,{style:{marginTop:8},placeholder:"value",value:d,onChange:e=>c(e.target.value)})]}),(0,n.FD)(C.PopoverButtonGroup,{children:[(0,n.Y)(g.Button,{onClick:o,children:t({id:"aui.cancel"})}),(0,n.Y)(g.Button,{onClick:()=>{a(m,d)},disabled:0===l.length||0===d.length||e.queryContext?.some((({key:e})=>e===m)),type:"primary",children:t({id:"aui.ok"})})]})]})},b=e=>{let t;const[a,o]=(0,i.useState)(null),s=t=>{isNaN(Number(t))&&"ALL"!==e.type||e.onValueChanged?.(t)};if((0,i.useEffect)((()=>{"BOOL"!==e.type&&"ENUM"!==e.type&&o(e.value)}),[e.type,e.value]),"BOOL"===e.type)t=(0,n.Y)(g.Checkbox,{checked:"true"===e.value,disabled:e.isDisabled,onChange:()=>e.onValueChanged?.("true"===e.value?"false":"true")});else if(e.isDisabled)t=e.value;else if(e.type.startsWith("ENUM")){const a=m(e.type);t=(0,n.Y)(g.Select,{value:e.value,size:"small",onChange:e.onValueChanged,disabled:e.isDisabled,children:a.map((e=>(0,n.Y)(g.Select.Option,{value:e,children:e},e)))})}else t=(0,n.Y)(g.Input,{value:a??"",onChange:e=>o(e.target.value),onBlur:e=>{s(e.target.value)},onPressEnter:e=>{s(e.currentTarget.value)},size:"small",disabled:e.isDisabled});return(0,n.FD)("div",{css:{display:"flex",marginRight:16},children:[(0,n.Y)("div",{css:{flexGrow:1,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},title:e.name,children:e.name}),(0,n.Y)("div",{css:{textAlign:"right",flexGrow:1,flexShrink:1,marginLeft:10,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden",minWidth:35},children:t})]},e.name)},N=["drillthrough.hiddencolumns","subcube"],k=["mdx.kpi","mdx.member","mdx.formatters","mdx.set","mdx.measureAlias","mdx.defaultmembers","user-authentication"],E=["dashboard","page","widget"],I=(e,{sectionName:t,pageKey:a,leafKey:n})=>{const o="dashboard"===t?e:"page"===t?(0,c.W)(e,a):(0,y.B)(e,a,n);if(!o)throw new Error(`Impossible to edit the ${t}'s query context, as its corresponding state was not found.`);return o},K=(e,t,a)=>{e.queryContext||(e.queryContext=[]),e.queryContext.splice(a,0,t)},w=({dashboardState:e,pageKey:t,leafKey:a,userQueryContext:n,sectionName:s,queryContextEntry:i,index:r})=>{let l=n,u=e;return"user"===s?l=(0,o.produce)(n,(e=>{e.splice(r,0,i)})):u=(0,o.produce)(e,(e=>{const n=I(e,{sectionName:s,pageKey:t,leafKey:a});K(n,i,r)})),[u,l]},O=(e,t)=>{if(!e.queryContext)return;const{queryContext:a}=e;a.splice(t,1),0===a.length&&delete e.queryContext},Y=({dashboardState:e,pageKey:t,leafKey:a,userQueryContext:n,sectionName:s,index:i})=>{let r=n,l=e;return"user"===s?r=(0,o.produce)(n,(e=>{e.splice(i,1)})):l=(0,o.produce)(e,(e=>{const n=I(e,{sectionName:s,pageKey:t,leafKey:a});O(n,i)})),[l,r]},S=(0,p.n)((e=>{const{dashboardState:t,pageKey:a,leafKey:c,onDashboardChange:y}=(0,l.M)(e)?e:{},{cube:p,dataModel:g}=(0,f.useCube)(e.widgetState),{widgetState:C,onWidgetChange:S}=e,{formatMessage:T}=(0,r.useIntl)(),[q,,]=(0,u.J)("canUseUserQueryContext");let D=E;q&&(D=["user",...E]);const _=(0,f.useQueryContexts)({widgetState:C,dashboardState:t,pageKey:a}),[,Q]=(0,d.v)("userQueryContext"),[R,P]=(0,i.useState)(),B=function(e){const t=e.contextValues,[a]=(0,u.J)("contextValues");return(0,i.useMemo)((()=>"*"===a?t:(0,s.pickBy)(t,(({name:e})=>a.some((t=>e===t))))),[a,t])}(g),V=(0,i.useCallback)((e=>{if(B[e])return B[e].type;const t=(0,s.findKey)(B,(({name:t})=>e.startsWith(t.replace(/\$.*\$$/,""))));return t?B[t].type:"ALL"}),[B]),M=(0,i.useMemo)((()=>{const e=Object.values(B).filter((({name:e})=>!N.some((t=>e.startsWith(t))))),t=(0,s.groupBy)(e,(({category:e})=>e||"misc"));return Object.entries(t).map((([e,t])=>({caption:e,isFolder:!0,isActionable:!1,type:e,children:t.map((t=>{const a={type:"QUERY_CONTEXT_ENTRY",key:t.name};return{caption:t.name,type:e,isActionable:!0,isDisabled:D.every((e=>_[e]?.some((({key:e})=>e===t.name)))),dragItem:a}}))})))}),[B,_,D]),U=(0,i.useMemo)((()=>{const e={};return e.default={placeholder:T({id:"aui.tool.queryContextEditor.noQueryContextEntries"}),caption:T({id:"aui.tool.queryContextEditor.defaultSection"}),tiles:Object.values(p.contextValues).filter((({name:e})=>k.every((t=>!e.startsWith(t)))&&N.every((t=>!e.startsWith(t))))).map((({name:e,value:t},a)=>{const o={key:e,value:t,fromPosition:{sectionName:"default",tileIndex:a},type:"QUERY_CONTEXT_ENTRY"};return{caption:(0,n.Y)(b,{name:e,value:t,isDisabled:!0,type:V(e)}),dragItem:o,isDisabled:D.some((t=>_[t]?.some((({key:t})=>t===e)))),isRemovable:!1}}))},D.forEach((s=>{const i=_[s];e[s]={caption:T({id:`aui.tool.queryContextEditor.${s}Section`}),tiles:i?i.map((({key:e,value:i},r)=>{const l={key:e,value:i,fromPosition:{sectionName:s,tileIndex:r},type:"QUERY_CONTEXT_ENTRY"},u=D.slice(D.indexOf(s)+1).some((t=>_[t]?.some((t=>e===t.key))));return{caption:(0,n.Y)(b,{name:e,value:i,type:V(e),isDisabled:u,onValueChanged:e=>{if(y&&t&&a&&c)if("user"===s){if(!_.user)return;const t=(0,o.produce)(_.user,(t=>{t[r].value=e}));Q(t)}else{const n=(0,o.produce)(t,(t=>{I(t,{leafKey:c,pageKey:a,sectionName:s}).queryContext[r].value=e}));y(n)}else{const t=(0,o.produce)(C,(t=>{t.queryContext[r].value=e}));S(t)}}}),isRemovable:!0,isDisabled:u,dragItem:l}})):[]}})),R&&e[R.sectionName].tiles.splice(R.tileIndex,0,{caption:R.key,dragItem:null}),e}),[R,V,p.contextValues,_,t,T,c,y,S,a,C,Q,D]),L=(0,i.useCallback)((({sectionName:e,tileIndex:n})=>{if(y&&t&&a&&c){const[o,s]=Y({dashboardState:t,pageKey:a,leafKey:c,userQueryContext:_.user||[],sectionName:e,index:n});o!==t&&y(o),s!==_.user&&Q(s)}else{const e=(0,o.produce)(C,(e=>{O(e,n)}));S(e)}}),[t,c,y,a,_.user,C,S,Q]),$=(0,i.useCallback)(((e,n,s)=>{const i=s??(_[e]?.length||0);if(-1!==n.indexOf("$"))P({sectionName:e,tileIndex:i,key:n});else if("mdx.measureAliases"===n)P({sectionName:e,tileIndex:i,key:n+".$measure_name$"});else{const s={key:n,value:((e,t)=>{if(!e)return"";const a=t[e.name];if(e.type.startsWith("ENUM"))return m(e.type)[0];switch(e.type){case"BOOL":return void 0!==a?a.value:"true";case"LONG":case"INTEGER":case"DOUBLE":return void 0!==a?a.value:"0";default:return a?.value||""}})(B[n],p.contextValues)};if(y&&t&&a&&c){const[n,o]=w({dashboardState:t,pageKey:a,leafKey:c,userQueryContext:_.user||[],sectionName:e,queryContextEntry:s,index:i});n!==t&&y(n),o!==_.user&&Q(o)}else{const e=(0,o.produce)(C,(e=>{K(e,s,i)}));S(e)}}}),[B,t,c,y,S,a,_,C,p.contextValues,Q]),A=(0,i.useCallback)((e=>{e.isActionable&&!_.widget?.some((({key:t})=>t===e.caption))&&$("widget",e.caption)}),[$,_]),W=(0,i.useCallback)(((e,n)=>{if(R){const s={key:e,value:n};if(y&&t&&a&&c){const[e,n]=w({dashboardState:t,pageKey:a,leafKey:c,userQueryContext:_.user||[],sectionName:R.sectionName,queryContextEntry:s,index:R.tileIndex});e!==t&&y(e),n!==_.user&&Q(n)}else{const e=(0,o.produce)(C,(e=>{K(e,s,R.tileIndex)}));S(e)}P(void 0)}}),[t,c,y,S,a,R,C,Q,_.user]),F=(0,i.useCallback)((({dragItem:e,toPosition:{sectionName:n,tileIndex:o}})=>{if(y&&t&&a&&c){let s=t,i=_.user??[];"default"!==e.fromPosition.sectionName&&([s,i]=Y({dashboardState:t,pageKey:a,leafKey:c,userQueryContext:_.user||[],sectionName:e.fromPosition.sectionName,index:e.fromPosition.tileIndex})),"default"!==n&&([s,i]=w({dashboardState:s,pageKey:a,leafKey:c,userQueryContext:i||[],sectionName:n,index:o,queryContextEntry:{key:e.key,value:e.value}})),s!==t&&y(s),i!==_.user&&Q(i)}}),[t,c,y,a,Q,_.user]),G=(0,i.useCallback)((({dragItem:e,toPosition:{sectionName:t,tileIndex:a}})=>{$(t,e.key,a)}),[$]);return(0,n.FD)(f.ResizableEditor,{children:[(0,n.Y)(x.P,{value:M,isSearchVisible:!0,searchPlaceholder:T({id:"aui.tool.queryContextEditor.searchContextEntries"}),onClick:A,expandTrigger:"full-node"}),(0,n.Y)(h.s,{css:{overflow:"auto"},sections:U,dragItemTypes:["QUERY_CONTEXT_ENTRY"],canDrop:({dragItem:e,toPosition:{sectionName:t}})=>"QUERY_CONTEXT_ENTRY"===e.type&&"default"!==t&&e?.fromPosition?.sectionName!==t&&!_[t]?.some((({key:t})=>t===e.key)),onTileRemoved:L,onTileMoved:F,onTileAdded:G,popoverProps:{title:T({id:"aui.tool.queryContextEditor.editContextValue"}),position:R,content:R&&(0,n.Y)(v,{onOk:W,templatedName:R.key,onCancel:()=>P(void 0),queryContext:_[R.sectionName]})}})]})}))}}]);