name: Update Homebrew Tap

on:
  release:
    types: [published]

jobs:
  update-homebrew-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release-info
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Trigger Homebrew tap update
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.HOMEBREW_TAP_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/jessegoodier/homebrew-kpf/dispatches \
            -d '{
              "event_type": "update-homebrew-formula",
              "client_payload": {
                "version": "${{ steps.release-info.outputs.version }}",
                "repository": "${{ github.repository }}"
              }
            }'

      - name: Create workflow summary
        run: |
          echo "🍺 Triggered Homebrew tap update for kpf version ${{ steps.release-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Homebrew formula will be updated automatically in the [homebrew-kpf](https://github.com/jessegoodier/homebrew-kpf) repository." >> $GITHUB_STEP_SUMMARY