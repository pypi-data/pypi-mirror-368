<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>D3 Map â€“ California Outline & Markers</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    /* The container for the SVG */
    #map {
      width: 100%;
      height: 100%;
    }
    /* --- Marker Styles --- */
    /* Partial markers: small gray circles */
    .marker-partial {
      fill: #929292;
      stroke: #555;
      stroke-width: 1;
    }
    /* Complete markers: beige teardrop shape with drop shadow */
    .marker-complete {
      filter: url(#drop-shadow);
      fill: #febf80;
      stroke: #000;
      stroke-width: 1;
    }
    /* Instrumented markers: blue teardrop shape with drop shadow */
    .marker-instrumented {
      filter: url(#drop-shadow);
      fill: #2f9ad4;
      stroke: #000;
      stroke-width: 1;
    }
  </style>
</head>
<body>
  <!-- The container holds the marker data via a data attribute -->
  <div id="map" data-bridges='{{ data|safe }}'></div>

  <script>
    // Select the container and parse marker data from its data attribute.
    const container = d3.select("#map");
    const bridgesData = JSON.parse(container.attr("data-bridges"));

    // Get container dimensions.
    const width = container.node().clientWidth;
    const height = container.node().clientHeight;

    // Append an SVG element that fills the container.
    const svg = container.append("svg")
      .attr("width", width)
      .attr("height", height);

    // Append a defs element to hold the drop shadow filter.
    const defs = svg.append("defs");
    const filter = defs.append("filter")
      .attr("id", "drop-shadow")
      .attr("height", "130%");
    filter.append("feGaussianBlur")
      .attr("in", "SourceAlpha")
      .attr("stdDeviation", 2)
      .attr("result", "blur");
    filter.append("feOffset")
      .attr("in", "blur")
      .attr("dx", 0)
      .attr("dy", 2)
      .attr("result", "offsetBlur");
    const feMerge = filter.append("feMerge");
    feMerge.append("feMergeNode").attr("in", "offsetBlur");
    feMerge.append("feMergeNode").attr("in", "SourceGraphic");

    // Load the California outline GeoJSON.
    d3.json("/california.json").then(california => {
      // Create a projection that fits the California GeoJSON into the SVG.
      const projection = d3.geoMercator().fitSize([width, height], california);
      const path = d3.geoPath().projection(projection);

      // Draw the California outline.
      svg.append("path")
        .datum(california)
        .attr("d", path)
        .attr("fill", "none")
        .attr("stroke", "#000")
        .attr("stroke-width", 3);

      // Helper: project a marker's [lon, lat] to [x, y] in the SVG.
      const projectPoint = d => projection([d.lon, d.lat]);

      // ----- Draw Partial markers as circles -----
      svg.selectAll("circle.marker-partial")
         .data(bridgesData.Partial)
         .enter()
         .append("circle")
         .attr("class", "marker-partial")
         .attr("r", 3)
         .attr("cx", d => projectPoint(d)[0])
         .attr("cy", d => projectPoint(d)[1]);

      // Define the teardrop marker shape as a reusable path string.
      const teardropPath = "M15 0C8.383 0 3 5.383 3 12c0 8.25 12 24.75 12 24.75S27 20.25 27 12c0-6.617-5.383-12-12-12zM15 16.4c-2.427 0-4.4-1.973-4.4-4.4 0-2.427 1.973-4.4 4.4-4.4 2.427 0 4.4 1.973 4.4 4.4 0 2.427-1.973 4.4-4.4 4.4z";

      // ----- Draw Instrumented markers (blue teardrop) -----
      // These will be scaled to a width of ~20px (original viewBox width is 30).
      svg.selectAll("path.marker-instrumented")
         .data(bridgesData.Instrumented)
         .enter()
         .append("path")
         .attr("class", "marker-instrumented")
         .attr("d", teardropPath)
         .attr("transform", d => {
            const [x, y] = projectPoint(d);
            const scale = 20 / 30;  // scale down to 20px width
            // The teardrop shape is defined in a 30x44 viewBox; its tip is at (15,44).
            // We shift so the tip aligns with the projected [x,y].
            return `translate(${x - 15 * scale}, ${y - 44 * scale}) scale(${scale})`;
         });

      // ----- Draw Complete markers (beige teardrop) -----
      svg.selectAll("path.marker-complete")
         .data(bridgesData.Complete)
         .enter()
         .append("path")
         .attr("class", "marker-complete")
         .attr("d", teardropPath)
         .attr("transform", d => {
            // In the original code, complete markers are offset slightly in latitude (+0.2).
            // Compute the projected offset.
            const [x, y] = projectPoint(d);
            const shifted = projection([d.lon, d.lat + 0.2]);
            const dy = shifted[1] - y;
            // Use the full size (30px wide) for complete markers.
            const scale = 1;
            return `translate(${x - 15 * scale}, ${y - 44 * scale + dy}) scale(${scale})`;
         });
    });
  </script>
</body>
</html>
