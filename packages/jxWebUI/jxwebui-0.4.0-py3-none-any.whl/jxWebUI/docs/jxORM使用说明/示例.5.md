
我们经常需要提供一些后台管理功能，本示例展示了后台管理功能中最基础的用户管理。

## webUI_user.py

    from jxWebUI import jxWebCapa, jxWebGetUser
    from jxORM import ORM, DBDataType, ColType, get_db
    
    #保存到数据库中的是MD5算法散列后的用户名+创建日期+密码的结果
    def get_passwd_md5(username, create_time, pwd):
        import hashlib
        m = hashlib.md5()
        m.update(username.encode('utf-8'))
        m.update(create_time.encode('utf-8'))
        m.update(pwd.encode('utf-8'))
        return m.hexdigest()
    
    #用户数据类
    @ORM
    class User:
        ID:DBDataType.Long = ColType.PrimaryKey
        CreateTime:DBDataType.DataTime = 1
        Type:DBDataType.Chars
        Name:DBDataType.Chars = 2
        Passwd:DBDataType.Chars
        Noused:DBDataType.Bool
        Info:DBDataType.Json
    
    #根据User类的定义在数据库中创建User表，如果已经创建，则只记日志，其它无影响
    db = get_db()
    with db.transaction():
        User.create(db)
        
    #web登录的用户类
    class webUser:
        def __init__(self, name):
            self._name = name
            self._abbr = name
            self._roles = [ ]
    
        def name(self):
            return self._name
        def abbr(self):
            return self._abbr
        def roles(self):
            return self._roles
    
    #用户登录的身份验证程序
    def get_user(user, pwd):
        #获取默认的数据库连接
        db = get_db()
        #只查询则可以不使用事务
        with db:
            #根据用户名查询用户
            u = User.GetByName(db, user)
            if u is None:
                #如果用户名不存在则拒绝登录
                return None
            #jxORM会自动完成数据库数据类型和python数据类型的转换，所以CreateTime是datetime类型，需要先转换成字符串
            ct = u.CreateTime.strftime("%Y-%m-%d %H:%M:%S")
            pwd = get_passwd_md5(user, ct, pwd)
            if u.Passwd != pwd:
                #密码验证失败则拒绝登录
                return None
            return webUser(user)
    
    #一般用户的默认密码
    _default_passwd_normal = '123456'
    #admin用户的默认密码
    _default_passwd_admin = 'admin'
    
    #初始化admin用户
    def init_admin():
        db = get_db()
        #因为可能创建用户，所以需要使用事务
        with db.transaction():
            u = User.GetByName(db, 'admin')
            if u is not None:
                #admin用户已经存在，不需要初始化
                return
            u = User()
            u.Name = 'admin'
            u.Type = 'admin'
            ct = u.CreateTime.strftime("%Y-%m-%d %H:%M:%S")
            u.Passwd = get_passwd_md5('admin', ct, _default_passwd_admin)
            u.insert(db)
    
    #初始化一般都用户的密码
    def init_passwd(db, username):
        u = User.GetByName(db, username)
        if not u:
            return False
        ct = u.CreateTime.strftime("%Y-%m-%d %H:%M:%S")
        u.Passwd = get_passwd_md5(username, ct, _default_passwd_normal)
        u.update(db)
        return True
    
    init_admin()
    #为jxWebUI的用户登录提供身份验证程序
    jxWebGetUser(get_user)
    
    #创建用户管理的capa
    capa = jxWebCapa('mgr.user')
    #在快捷栏的【用户管理】中添加【查看用户】
    capa.shortCutTree_add_item('用户管理', '查看用户', 'list_user', authority='admin')
    #在快捷栏的【用户管理】中添加【添加用户】
    capa.shortCutTree_add_item('用户管理', '添加用户', 'add_user', authority='admin')
    #在快捷栏的【用户管理】中添加【修改密码】
    capa.shortCutTree_add_item('用户管理', '修改密码', 'change_passwd')
    
    #列表所有用户
    def disp_list_user(ci, db):
        rs = []
        #查询所有未删除的用户
        expression_list = [('Noused', '==', False)]
        #查询结果是User表行所组成的list
        l = User.searchBy_expression_list(db, expression_list)
        for d in l:
            #每一行就是User表中的一行，d是一个dict，是【列名:利值】的键值对组成的dict
            rs.append({'username':d.get('Name'), 'createTime':d.get('CreateTime').strftime("%Y-%m-%d %H:%M:%S")})
        #将结果输出到数据表【table_user】
        ci.set_output_datatable('table_user', rs)
    
    #list_user页面【查看用户】打开后的初始化函数
    @capa.disp
    def list_user(ci, db, ctx):
        disp_list_user(ci, db)
    
    #list_user页面【查看用户】的界面描述函数
    @capa.web
    def list_user(page):
        #定义数据表：用户列表，共四列，前两列是创建时间、用户名，后两列是操作列：删除操作、重置密码操作
        t = page.dataTable('table_user').width(900).title('用户列表')
        t.col('createTime').head('创建时间').width(300)
        t.col('username').head('用户名').width(200)
        #删除操作是一个工具条，点击后会调用命令函数：del_user，同时会将用户名作为参数传递给命令函数，在执行del_user前会弹窗请求用户确认
        t.col('op1').head('操作').width(80).a().text('删除').motion('cmd').demand('del_user').require(['username']).confirm('确定要删除用户吗？')
        t.col('op2').head('操作').width(80).a().text('重置密码').motion('cmd').demand('reset_passwd').require(['username']).confirm('确定要重置用户密码吗？')
    
    #点击删除操作并确认后将调用本函数
    @capa.cmd
    def del_user(ci, db, ctx):
        #先查询用户是否存在
        username = ci.getInput('username')
        if username=='admin':
            ci.web_info('警告', '不能删除admin用户')
            return
    
        #实际函数在调用前，jxWebUI会自动获取数据库连接并启用事务，可以直接使用db参数
        u = User.GetByName(db, username)
        if not u:
            #输入参数来自删除操作所在行的用户名列，而用户名列中的数据来自数据库，所以理论上不可能出现not u的情况，这里只是为了容错
            return
        #逻辑删除
        u.Noused = True
        u.update(db)
    
        #数据表内容发生了变化，刷新前先清除旧内容
        ci.setAttr('table_user', 'clear', True)
    
        #刷新用户表
        disp_list_user(ci, db)
    
    #点击重置密码操作并确认后将调用本函数
    @capa.cmd
    def reset_passwd(ci, db, ctx):
        username = ci.getInput('username')
        init_passwd(db, username)
        ci.web_info('警告', '密码已重置')
    
    #change_passwd页面【修改密码】的界面描述函数
    @capa.web
    def change_passwd(page):
        t = page.table().width(900).title('修改用户密码')
        r = t.row()
        r.text().width(200).text('新密码')
        r.input().width(200).bind('new_password')
        r.text().width(200).text('再次输入密码')
        r.input().width(200).bind('new_password_2')
        r = t.row()
        r.button().width(100).text('修改').motion('cmd').demand('change_passwd').confirm('确定要修改用户密码吗？')
    
    @capa.cmd
    def change_passwd(ci, db, ctx):
        pwd1 = ci.getInput('new_password')
        pwd2 = ci.getInput('new_password_2')
        if pwd1 != pwd2:
            ci.web_info('警告', '两次输入的密码不一致')
            return
        #修改密码是修改自己的密码，就需要从上下文中获取到当前登录用户的用户名
        username = ctx.user.name()
        u = User.GetByName(db, username)
        ct = u.CreateTime.strftime("%Y-%m-%d %H:%M:%S")
        u.Passwd = get_passwd_md5(username, ct, pwd1)
        u.update(db)
        ci.web_info('警告', '密码已修改')
    
    #add_user页面【添加用户】的界面描述函数
    @capa.web
    def add_user(page):
        t = page.table().width(900).title('创建用户')
        r = t.row()
        r.text().width(200).text('用户名')
        r.input().width(200).bind('username')
        r = t.row()
        r.button().width(100).text('创建').motion('cmd').demand('add_user').confirm('确定要创建用户吗？')
    
    @capa.cmd
    def add_user(ci, db, ctx):
        username = ci.getInput('username')
        u = User.GetByName(db, username)
        if u is not None:
            if u.Noused:
                #用户可能是以前被删除的用户
                u.Noused = False
                u.Type = 'normal'
                ct = u.CreateTime.strftime("%Y-%m-%d %H:%M:%S")
                u.Passwd = get_passwd_md5(username, ct, _default_passwd_normal)
                u.update(db)
            else:
                ci.web_info('警告', '用户已存在')
                return
        else:
            u = User()
            u.Name = username
            u.Type = 'normal'
            ct = u.CreateTime.strftime("%Y-%m-%d %H:%M:%S")
            u.Passwd = get_passwd_md5(username, ct, _default_passwd_normal)
            u.insert(db)
    
        ci.web_info('警告', '用户已创建')
    

## webUI.py

    from jxWebUI import jxWebLogger, jxWebServer, jxWebSQLGetDBConnection
    from jxORM import jxDB, get_default_db

    #设置数据库连接：sqlite数据库：testDB.db
    jxDB.set('testDB', type=DBType.SQLite)

    #将jxORM的默认数据库关联给jxWebUI
    jxWebSQLGetDBConnection(get_default_db, is_custom=True)
    
    jxWebLogger.info(f'webUI init...')
    
    from mgr.user import webUI_user
    ...导入其它ui模块
    
    
    webUI_server_port = 10068
    jxWebLogger.info(f'webUI starting at {webUI_server_port}')
    #启动jxWebUI的server
    jxWebServer.start(port=webUI_server_port)
    

## 启用

在main.py或其它主程序启动的py文件中，导入webUI.py即可。