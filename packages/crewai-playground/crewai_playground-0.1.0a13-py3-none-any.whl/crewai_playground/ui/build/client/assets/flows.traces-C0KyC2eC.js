import{w as oe,u as de}from"./store-BDLt0vbv.js";import{q as me,p as xe,r,l as e}from"./chunk-GNGMS2XR-KLeu_BA0.js";import{a as ue,L as he,B as pe,f as fe}from"./Layout-CP5Hc7nX.js";import{F as je}from"./FlowNavigation-DHrQLs8L.js";import{C as p,a as f,b as I,c as D,d as F}from"./card-DMpzrDC2.js";import{T as ge,a as we,b as V,c as R}from"./tabs-BvsZBTz_.js";import{S as Ne,b as ve,c as ye,d as be,e as Te,a as Se,C as _e}from"./sheet-DgYB9uNH.js";import{B as A}from"./badge-CzGG4LGd.js";import{I as K,T as Ce,a as Ee,b as ke,A as Ie,c as De,d as Fe,e as Me,S as Ae}from"./scroll-area-CkefNqLd.js";import{A as Oe,a as Le,b as $e}from"./alert-DAr1l6eU.js";import"./select-CrlOLXkx.js";import{L as ze,P as q}from"./play-BgHo1Tz0.js";import{C as H}from"./clock-D9RgnNZI.js";import"./index-BKaxNvVC.js";import"./chevron-down-BlJJcPQY.js";import"./transform-BEtJ_6wc.js";/**
 * @license lucide-react v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]],Be=ue("List",Pe);function rs(){return[{title:"CrewAI - Flow Traces"},{name:"description",content:"View execution traces for flows"}]}const $=l=>{try{return new Date(l).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3})}catch{return"--:--:--"}},J=(l,h)=>{try{const b=new Date(l).getTime(),j=(h?new Date(h).getTime():Date.now())-b;if(j<1e3)return`${j}ms`;if(j<6e4)return`${(j/1e3).toFixed(1)}s`;{const M=Math.floor(j/6e4),N=Math.floor(j%6e4/1e3);return`${M}m ${N}s`}}catch{return"--"}},U=l=>{switch(l.toLowerCase()){case"completed":case"success":return"bg-green-100 text-green-800";case"failed":case"error":return"bg-red-100 text-red-800";case"running":case"started":return"bg-blue-100 text-blue-800";case"initializing":case"pending":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}},z=l=>{switch(l.toLowerCase()){case"completed":case"success":return e.jsx(_e,{className:"h-4 w-4"});case"failed":case"error":return e.jsx(Se,{className:"h-4 w-4"});case"running":case"started":return e.jsx(q,{className:"h-4 w-4"});case"initializing":case"pending":return e.jsx(H,{className:"h-4 w-4"});default:return e.jsx(K,{className:"h-4 w-4"})}};function Z(l){var c;const h=Object.keys(l.methods||{}).length,b=((c=l.events)==null?void 0:c.length)||0,w=new Date(l.start_time).getTime(),M=(l.end_time?new Date(l.end_time).getTime():Date.now())-w,N=Object.values(l.methods||{}).filter(g=>g.status==="completed").length,O=Object.values(l.methods||{}).filter(g=>g.status==="failed").length,_=Object.values(l.methods||{}).reduce((g,v)=>g+(v.outputs?JSON.stringify(v.outputs).length:0),0);return{totalMethods:h,totalEvents:b,executionTime:M,completedMethods:N,failedMethods:O,totalOutputSize:_}}const ls=oe(function(){var Y;me();const[h,b]=xe(),{flows:w,setFlows:j}=de(),[M,N]=r.useState(!1),[O,_]=r.useState(null),[c,g]=r.useState(""),[v,L]=r.useState([]),[T,S]=r.useState(null),[Ve,X]=r.useState(null),[P,G]=r.useState(null),[ee,se]=r.useState("overview"),[te,Q]=r.useState(!1),[i,ae]=r.useState(null),[Re,Je]=r.useState(new Set),B=r.useRef(null),o=r.useMemo(()=>!T||!Array.isArray(v)?null:v.find(s=>s&&s.id===T)||null,[v,T]);r.useEffect(()=>{const s=h.get("flowId"),t=h.get("traceId");s&&g(s),t&&S(t)},[h]),r.useEffect(()=>{const s=new URLSearchParams;c&&s.set("flowId",c),T&&s.set("traceId",T),b(s)},[c,T,b]),r.useEffect(()=>{const s=async()=>{try{const a=await(await fetch("/api/flows")).json();a.flows&&(j(a.flows),a.flows.length>0&&!c&&g(a.flows[0].id))}catch(t){console.error("Error fetching flows:",t),_("Failed to fetch flows. Please try again later.")}finally{N(!1)}};w.length?!c&&w.length>0&&g(w[0].id):(N(!0),s())},[w,j,c]),r.useEffect(()=>{const s=h.get("flowId");s&&!c&&g(s)},[h,c]),r.useEffect(()=>{(async()=>{if(!c){L([]),S("");return}try{N(!0),_(null),h.get("flowId")!==c&&b({flowId:c});const a=await(await fetch(`/api/flows/${c}/traces`)).json();if(a.status==="success"&&Array.isArray(a.traces)){console.log("Received traces:",a.traces);const n=a.traces.filter(m=>m&&typeof m=="object"&&m.id&&m.start_time!==void 0&&(m.status==="completed"||m.status==="failed"||m.status==="running"||m.status==="initializing"));n.sort((m,C)=>{const u=typeof m.start_time=="number"?m.start_time:0;return(typeof C.start_time=="number"?C.start_time:0)-u}),console.log("Valid traces after filtering:",n),L(n),n.length>0&&!T?S(n[0].id):n.length===0&&S("")}else _(a.detail||"Failed to fetch flow traces"),L([]),S("")}catch(t){console.error("Error fetching flow traces:",t),_("Failed to fetch flow traces. Please try again later."),L([]),S("")}finally{N(!1)}})()},[c]),r.useMemo(()=>o?Z(o):null,[o]);const ne=r.useMemo(()=>{if(!o)return[];const s=[],t=new Date(o.start_time),a=o.end_time?new Date(o.end_time):null,n=a?a.getTime()-t.getTime():0,m={id:o.id,name:`Flow: ${o.flow_name}`,startTime:t,endTime:a,status:o.status,depth:0,duration:n,serviceName:"flow",operation:"execution",children:[]};if(s.push(m),o.events&&o.events.length>0){const u=new Map;o.events.forEach(x=>{if(x.type==="flow.method.execution"){const E=x.method_name||"unknown_method";u.has(E)||u.set(E,{name:E,startTime:null,endTime:null,status:"unknown",events:[]});const y=u.get(E);y.events.push(x);const k=new Date(x.timestamp);x.status==="started"?(y.startTime=k,y.status="running"):(x.status==="completed"||x.status==="failed")&&(y.endTime=k,y.status=x.status)}}),u.forEach((x,E)=>{const y=x.startTime||t,k=x.endTime||null,le=k?k.getTime()-y.getTime():0,ce={id:`${o.id}-method-${E}`,name:`Method: ${x.name}`,startTime:y,endTime:k,status:x.status,parentId:o.id,depth:1,duration:le,serviceName:"method",operation:x.name,children:[]};s.push(ce)})}const C=new Map;return s.forEach(u=>C.set(u.id,u)),s.forEach(u=>{u.parentId&&C.has(u.parentId)&&C.get(u.parentId).children.push(u)}),s},[o]),ie=s=>{G(s),X(s.id),setTimeout(()=>{B.current&&B.current.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)},re=s=>{ae(s),S(s.id),G(null),X(null),Q(!0)},W=r.useMemo(()=>{const s=new Map;return w.forEach(t=>{s.set(t.id,{flow:t,traces:[]})}),v.forEach(t=>{const a=s.get(t.flow_id);a&&a.traces.push(t)}),Array.from(s.entries()).filter(([t,a])=>a.traces.length>0).map(([t,a])=>({flowId:t,...a}))},[w,v]),d=r.useMemo(()=>i?Z(i):null,[i]);return e.jsx(he,{children:e.jsxs("div",{className:"w-full",children:[O&&e.jsxs(Oe,{variant:"destructive",className:"mb-6",children:[e.jsx(Le,{children:"Error"}),e.jsx($e,{children:O})]}),e.jsx(je,{}),M?e.jsx(p,{className:"mb-6",children:e.jsxs(f,{className:"flex items-center justify-center py-12",children:[e.jsx(ze,{className:"h-8 w-8 animate-spin text-indigo-500 mr-2"}),e.jsx("p",{children:"Loading flow traces..."})]})}):W.length===0?e.jsx(p,{className:"mb-6",children:e.jsx(f,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Be,{className:"h-12 w-12 mx-auto text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Flow Traces Found"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"There are no execution traces available for flows yet."})]})})}):e.jsx("div",{className:"grid grid-cols-1 gap-6",children:e.jsxs(p,{children:[e.jsx(I,{className:"flex flex-row justify-between items-start",children:e.jsxs("div",{children:[e.jsx(D,{children:"Flow Execution Traces"}),e.jsx(F,{children:"Click a trace to view detailed execution information"})]})}),e.jsx(f,{children:e.jsx("div",{className:"space-y-4",children:W.map(({flowId:s,flow:t,traces:a})=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold text-lg",children:t.name}),e.jsxs(A,{variant:"outline",className:"text-xs",children:[a.length," trace",a.length!==1?"s":""]})]}),e.jsx("div",{className:"space-y-2",children:a.map(n=>{var m;return e.jsx("div",{className:"border rounded-lg overflow-hidden hover:bg-muted/10 transition-all cursor-pointer w-full",onClick:()=>re(n),children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[z(n.status),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:"font-medium mr-2",children:["Trace ",n.id.slice(0,8)]}),e.jsx(A,{variant:n.status==="completed"?"outline":n.status==="running"?"default":"destructive",className:n.status==="completed"?"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300":"",children:n.status})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:[$(n.start_time)," â€¢"," ",J(n.start_time,n.end_time)]})]})]}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"Methods:"}),e.jsx("span",{className:"font-bold",children:Object.keys(n.methods||{}).length})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"Events:"}),e.jsx("span",{className:"font-bold",children:((m=n.events)==null?void 0:m.length)||0})]}),e.jsx(pe,{variant:"ghost",size:"sm",className:"ml-2",children:e.jsx(fe,{className:"h-5 w-5"})})]})]})})},n.id)})})]},s))})})]})}),e.jsx(Ne,{open:te,onOpenChange:Q,children:e.jsxs(ve,{className:"w-[75vw] max-w-[75vw] sm:w-[75vw] md:w-[75vw] lg:w-[75vw] overflow-y-auto",children:[e.jsxs(ye,{children:[e.jsx(be,{children:(i==null?void 0:i.flow_name)||"Flow Trace Details"}),e.jsxs(Te,{children:["Detailed execution information for trace"," ",(Y=i==null?void 0:i.id)==null?void 0:Y.slice(0,8)]})]}),i&&e.jsx("div",{className:"mt-6",children:e.jsxs(ge,{defaultValue:"overview",value:ee,onValueChange:se,className:"w-full",children:[e.jsxs(we,{className:"grid grid-cols-3 mb-4",children:[e.jsxs(V,{value:"overview",className:"flex items-center gap-1",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx("span",{children:"Overview"})]}),e.jsxs(V,{value:"methods",className:"flex items-center gap-1",children:[e.jsx(q,{className:"h-4 w-4"}),e.jsx("span",{children:"Methods"})]}),e.jsxs(V,{value:"events",className:"flex items-center gap-1",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("span",{children:"Events"})]})]}),e.jsx(R,{value:"overview",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(p,{children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Methods"}),e.jsx("p",{className:"text-2xl font-bold",children:(d==null?void 0:d.totalMethods)||0}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(d==null?void 0:d.completedMethods)||0," ","completed,"," ",(d==null?void 0:d.failedMethods)||0," ","failed"]})]})]})})}),e.jsx(p,{children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(H,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Events"}),e.jsx("p",{className:"text-2xl font-bold",children:(d==null?void 0:d.totalEvents)||0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Total events captured"})]})]})})}),e.jsx(p,{children:e.jsx(f,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ce,{className:"h-5 w-5 text-orange-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Execution Time"}),e.jsx("p",{className:"text-2xl font-bold",children:d!=null&&d.executionTime?`${Math.round(d.executionTime/1e3)}s`:"0s"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Total duration"})]})]})})})]}),e.jsxs(p,{children:[e.jsxs(I,{className:"pb-2",children:[e.jsx(D,{className:"text-lg",children:"Flow Summary"}),e.jsx(F,{children:"Overview of flow execution and status"})]}),e.jsxs(f,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Flow Name"}),e.jsx("div",{className:"text-sm font-mono",children:i.flow_name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Status"}),e.jsxs(A,{className:U(i.status),variant:"outline",children:[z(i.status),i.status]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Duration"}),e.jsx("div",{className:"text-sm",children:J(i.start_time,i.end_time)})]})]}),i.output&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Output"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded-md overflow-auto max-h-[400px] whitespace-pre-wrap break-words",children:typeof i.output=="string"?i.output:JSON.stringify(i.output,null,2)})]})]})]}),e.jsxs(p,{children:[e.jsxs(I,{className:"pb-2",children:[e.jsx(D,{className:"text-lg",children:"Execution Timeline"}),e.jsx(F,{children:"Visualization of execution spans over time"})]}),e.jsx(f,{children:e.jsx(Ee,{spans:ne,onSpanClick:ie})})]}),P&&e.jsxs(p,{ref:B,children:[e.jsxs(I,{className:"pb-2",children:[e.jsx(D,{className:"text-lg",children:"Span Details"}),e.jsxs(F,{children:["Detailed information for the selected span:"," ",P.name]})]}),e.jsx(f,{children:e.jsx(ke,{span:P})})]})]})}),e.jsx(R,{value:"methods",children:e.jsxs(p,{children:[e.jsxs(I,{className:"pb-2",children:[e.jsx(D,{className:"text-lg",children:"Methods"}),e.jsx(F,{children:"Flow execution methods and their details"})]}),e.jsx(f,{children:e.jsx("div",{className:"space-y-4",children:e.jsx(Ie,{type:"single",collapsible:!0,className:"w-full",children:Object.entries(i.methods||{}).map(([s,t])=>({...t,id:s,name:t.name||s})).map(s=>e.jsxs(De,{value:s.id,children:[e.jsx(Fe,{className:"hover:bg-muted px-4",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs(A,{className:U(s.status),variant:"outline",children:[z(s.status),s.status]}),e.jsx("span",{className:"ml-3 font-medium",children:s.name})]}),e.jsx("div",{className:"text-sm text-muted-foreground mr-4",children:J(s.start_time,s.end_time)})]})}),e.jsx(Me,{className:"px-4 pb-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Started:"}),e.jsx("br",{}),$(s.start_time)]}),s.end_time&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Completed:"}),e.jsx("br",{}),$(s.end_time)]})]}),s.outputs&&e.jsxs("div",{children:[e.jsx("div",{className:"font-medium mb-2",children:"Outputs:"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded-md overflow-auto max-h-[200px] whitespace-pre-wrap break-words",children:typeof s.outputs=="string"?s.outputs:JSON.stringify(s.outputs,null,2)})]})]})})]},s.id))})})})]})}),e.jsx(R,{value:"events",children:e.jsxs(p,{children:[e.jsxs(I,{className:"pb-2",children:[e.jsx(D,{className:"text-lg",children:"Events"}),e.jsx(F,{children:"Chronological list of all flow execution events"})]}),e.jsx(f,{children:e.jsx(Ae,{className:"h-[600px]",children:e.jsx("div",{className:"space-y-3",children:i.events&&i.events.sort((s,t)=>new Date(s.timestamp).getTime()-new Date(t.timestamp).getTime()).map((s,t)=>{const a=z(s.status),n=U(s.status);return e.jsxs("div",{className:"border rounded-lg p-4 hover:bg-muted/10 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`${n}`,children:a}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"font-medium",children:s.type}),e.jsx(A,{variant:"outline",children:s.method_name||"N/A"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Status: ",s.status]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:$(s.timestamp)})]}),(s.outputs||s.params||s.input_state||s.error)&&e.jsxs("details",{className:"mt-3",children:[e.jsx("summary",{className:"text-sm font-medium cursor-pointer hover:text-primary",children:"View Event Data"}),e.jsx("div",{className:"mt-2 text-xs font-mono bg-background/50 p-2 rounded border",children:JSON.stringify({...s.outputs&&{outputs:s.outputs},...s.params&&{params:s.params},...s.input_state&&{input_state:s.input_state},...s.error&&{error:s.error}},null,2)})]})]},t)})})})})]})})]})})]})})]})})});export{ls as default,rs as meta};
