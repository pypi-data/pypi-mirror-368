import{w as re,u as ie}from"./store-BDLt0vbv.js";import{q as ee,r as a,x as oe,l as e}from"./chunk-GNGMS2XR-KLeu_BA0.js";import{B as te,L as ce}from"./Layout-CP5Hc7nX.js";import{L as le,T as de,I as ue}from"./textarea-CUBdk2de.js";import{S as me,i as ge,j as he,k as pe,l as fe}from"./select-CrlOLXkx.js";import{K as xe}from"./KickoffNavigation-DfJcBmsR.js";import{A as we,a as be,b as ye}from"./alert-DAr1l6eU.js";import{C as je}from"./card-DMpzrDC2.js";import{d as se,a as Ne,b as ve,M as Q,i as Ce,C as Se,B as ke,c as Ee,e as Te,H as V,P as K}from"./index-K9TuxQyt.js";import{L as U}from"./play-BgHo1Tz0.js";import{M as Re}from"./index-ChbM4Wl4.js";import"./index-BKaxNvVC.js";import"./chevron-down-BlJJcPQY.js";import"./transform-BEtJ_6wc.js";const q=u=>{switch(u){case"completed":return"#6366f1";case"running":return"#10b981";case"waiting":return"#f59e0b";case"initializing":return"#3b82f6";case"pending":return"#64748b";default:return"#64748b"}},H=new se.graphlib.Graph().setDefaultEdgeLabel(()=>({})),$e=u=>({width:280,height:150}),Ie=(u,n,r="TB")=>{if(!u.length)return{nodes:u,edges:n,fullWidth:0,fullHeight:0};const{width:j,height:p}=$e(),g=Math.max(j,320),c=Math.max(p,200);H.setGraph({rankdir:r,nodesep:80,ranksep:150,align:"UL",marginx:50,marginy:50,edgesep:20}),u.forEach(i=>{i.data&&(i.data.uniformWidth=g,i.data.uniformHeight=c),H.setNode(i.id,{width:g,height:c})}),n.forEach(i=>{H.setEdge(i.source,i.target)}),se.layout(H);const f=H.graph(),w=f&&f.width?f.width/2:0,d=f&&f.height?f.height/2:0,C=u.map(i=>{const $=H.node(i.id);return $?{...i,position:{x:$.x-g/2,y:$.y-c/2},data:{...i.data,uniformWidth:g,uniformHeight:c}}:(console.warn(`No dagre node found for id: ${i.id}`),i)}),R=C.findIndex(i=>i.type==="crew");if(R!==-1){const i=C.filter($=>$.type==="agent");if(i.length>0){const $=i.map(E=>E.position.x),O=Math.min(...$),L=Math.max(...$),M=(O+L)/2,P=i.map(E=>E.position.y),_=Math.min(...P);C[R]={...C[R],position:{x:M,y:_-c-50}}}}return{nodes:C,edges:n,fullWidth:w,fullHeight:d}},We=({data:u,id:n})=>{const r=u,j=q(r.status),p=r.hasIncomingEdge??!1,g=r.hasOutgoingEdge??!1;return e.jsxs("div",{className:"px-4 py-3 shadow-md rounded-md bg-white border-2",style:{borderColor:j,width:r.uniformWidth?`${r.uniformWidth}px`:"320px",height:r.uniformHeight?`${r.uniformHeight}px`:"180px",overflow:"hidden"},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-sm",children:r.role}),e.jsx("div",{className:"rounded-full w-3 h-3",style:{backgroundColor:j}})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:r.name}),e.jsx("div",{className:"mt-2 text-xs",children:r.description&&r.description.length>80?`${r.description.substring(0,80)}...`:r.description}),r.associatedTasks&&r.associatedTasks.length>0&&e.jsxs("div",{className:"mt-3 border-t pt-2",children:[e.jsx("div",{className:"text-xs font-semibold mb-1",children:"Tasks:"}),e.jsx("div",{className:"space-y-2",children:r.associatedTasks.map(c=>e.jsxs("div",{className:"text-xs p-2 rounded bg-gray-50 border border-gray-100",style:{borderLeft:`3px solid ${q(c.status)}`},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium",children:c.description.length>50?`${c.description.substring(0,50)}...`:c.description}),e.jsx("div",{className:"ml-1 text-[10px] px-1.5 py-0.5 rounded-full font-medium",style:{backgroundColor:q(c.status),color:"white",opacity:.9},children:c.status})]}),c.output&&e.jsxs("div",{className:"mt-1.5",children:[e.jsx("div",{className:"text-[10px] text-gray-500 font-medium",children:"Output:"}),e.jsx("div",{className:"whitespace-pre-wrap overflow-hidden max-h-16 overflow-y-auto text-[10px] mt-0.5",children:typeof c.output=="string"?c.output.substring(0,120)+(c.output.length>120?"...":""):JSON.stringify(c.output,null,2).substring(0,120)+"..."})]})]},c.id))})]}),p&&e.jsx(V,{type:"target",position:K.Top,className:"w-2 h-2 bg-blue-500",isConnectable:!1}),g&&e.jsx(V,{type:"source",position:K.Bottom,className:"w-2 h-2 bg-blue-500",isConnectable:!1})]})},Ae=({data:u})=>{const n=u,r=q(n.status),j=n.hasIncomingEdge??!1,p=n.hasOutgoingEdge??!1;return e.jsxs("div",{className:"px-4 py-2 shadow-md rounded-md bg-white border-2 w-[280px]",style:{borderColor:r},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-sm",children:"Task"}),e.jsx("div",{className:"rounded-full w-3 h-3",style:{backgroundColor:r}})]}),n.assignedAgentName&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Assigned to: ",n.assignedAgentName]}),e.jsx("div",{className:"mt-2 text-xs",children:n.description&&n.description.length>100?`${n.description.substring(0,100)}...`:n.description}),j&&e.jsx(V,{type:"target",position:K.Top,className:"w-2 h-2 bg-blue-500",isConnectable:!1}),p&&e.jsx(V,{type:"source",position:K.Bottom,className:"w-2 h-2 bg-blue-500",isConnectable:!1})]})},Oe=({data:u})=>{const n=u,r=q(n.status);return e.jsxs("div",{className:"px-4 py-3 shadow-md rounded-md bg-white border-2 flex flex-col justify-center",style:{borderColor:r,width:n.uniformWidth?`${n.uniformWidth}px`:"320px",height:n.uniformHeight?`${n.uniformHeight}px`:"200px",overflow:"hidden"},children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("div",{className:"font-bold text-lg",children:"ðŸš€ Crew"}),e.jsx("div",{className:"rounded-full w-4 h-4",style:{backgroundColor:r}})]}),e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:n.name}),e.jsxs("div",{className:"text-xs text-gray-500 mb-2",children:["Status: ",n.status]}),e.jsx("div",{className:"mt-auto pt-2 border-t border-gray-100",children:e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsxs("div",{children:["Type: ",n.type||"Sequential"]}),n.started_at&&e.jsxs("div",{className:"mt-1",children:["Started: ",new Date(n.started_at).toLocaleTimeString()]})]})})]})},ze=({crewId:u,isRunning:n,resetKey:r=0})=>{var G,Y,Z;ee();const j=a.useRef(null),p=a.useRef(null),g=a.useRef(null),c=a.useRef(0),f=a.useRef(null),w=a.useRef(null),[d,C]=a.useState({crew:null,agents:[],tasks:[]}),[R,i]=a.useState([]),[$,O]=a.useState([]),[L,M]=a.useState(null),P=a.useCallback(s=>i(o=>Ne(s,o)),[]),_=a.useCallback(s=>O(o=>ve(s,o)),[]),[E,F]=a.useState("connecting"),[B,l]=a.useState(!1),[b,m]=a.useState(!1),[S,T]=a.useState(null),ne={agent:We,task:Ae,crew:Oe},X=a.useCallback(async s=>{if(s){l(!0),T(null);try{const o=await fetch(`/api/crews/${s}/initialize`,{method:"POST",headers:{"Content-Type":"application/json"}}),h=await o.json();if(!o.ok)throw new Error(h.message||"Failed to initialize crew");console.log("Crew initialization successful:",h)}catch(o){console.error("Error initializing crew:",o),T(`Failed to initialize crew: ${o instanceof Error?o.message:String(o)}`)}finally{l(!1)}}},[]),J=a.useCallback(()=>{if(p.current&&p.current.readyState===WebSocket.OPEN){console.log("WebSocket already connected");return}f.current&&(clearTimeout(f.current),f.current=null),w.current&&(clearInterval(w.current),w.current=null),F("connecting");try{const s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/crew-visualization/${u}`;console.log(`Connecting to WebSocket at ${s}`);const o=new WebSocket(s);p.current=o,o.onopen=()=>{console.log("WebSocket connection established"),c.current=0},o.onmessage=h=>{try{const t=JSON.parse(h.data);t.type==="connection_established"?(F("connected"),g.current=t.client_id,console.log(`Connection established with client ID: ${t.client_id}`),u&&o.send(JSON.stringify({type:"register_crew",crew_id:u})),w.current=setInterval(()=>{o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"ping"}))},3e4),o.send(JSON.stringify({type:"request_state"}))):t.type==="crew_registered"?console.log(`Registered for crew: ${t.crew_id}`):t.type==="pong"?console.log("Heartbeat pong received"):t.crew!==void 0||t.agents!==void 0||t.tasks!==void 0?(console.log("ðŸ”„ Received crew visualization data:",{crew:t.crew?{id:t.crew.id,status:t.crew.status,hasOutput:!!t.crew.output}:null,agents:t.agents?t.agents.length:0,tasks:t.tasks?t.tasks.length:0,timestamp:t.timestamp}),C(z=>{var N,k,v,A,D,I;const y={...z};if(t.crew!==void 0&&(y.crew=t.crew,console.log("âœ… Updated crew state:",{id:(N=t.crew)==null?void 0:N.id,status:(k=t.crew)==null?void 0:k.status,hasOutput:!!((v=t.crew)!=null&&v.output),outputLength:(A=t.crew)!=null&&A.output?t.crew.output.length:0}),((D=t.crew)==null?void 0:D.status)==="completed"&&((I=t.crew)!=null&&I.output)&&console.log("ðŸŽ‰ Crew completed with output! Result will be displayed.")),t.agents!==void 0){const W=new Map(z.agents.map(x=>[x.id,x]));t.agents.forEach(x=>{W.set(x.id,x)}),y.agents=Array.from(W.values()),console.log("ðŸ‘¥ Updated agents:",y.agents.map(x=>({id:x.id,status:x.status})))}if(t.tasks!==void 0){const W=new Map(z.tasks.map(x=>[x.id,x]));t.tasks.forEach(x=>{W.set(x.id,x)}),y.tasks=Array.from(W.values()),console.log("ðŸ“‹ Updated tasks:",y.tasks.map(x=>({id:x.id,status:x.status})))}return t.timestamp&&(y.timestamp=t.timestamp),y}),console.log("âœ… Setting hasReceivedData to true"),m(!0)):typeof t=="object"&&t!==null&&("crew"in t||"agents"in t||"tasks"in t||"timestamp"in t)&&(console.log("Fallback: Received potential crew data:",t),m(!0),C(z=>{const y={...z};return"crew"in t&&t.crew&&(y.crew=t.crew),"agents"in t&&t.agents&&(y.agents=t.agents),"tasks"in t&&t.tasks&&(y.tasks=t.tasks),"timestamp"in t&&t.timestamp&&(y.timestamp=t.timestamp),y}))}catch(t){console.error("Error processing WebSocket message:",t)}},o.onclose=h=>{if(console.log(`WebSocket connection closed: ${h.code} ${h.reason}`),F("disconnected"),w.current&&(clearInterval(w.current),w.current=null),c.current<5){const t=Math.min(1e3*2**c.current,3e4);console.log(`Attempting to reconnect in ${t}ms (attempt ${c.current+1}/5)`),f.current=setTimeout(()=>{c.current+=1,J()},t)}else console.log("Maximum reconnection attempts reached"),T("Failed to connect to visualization service after multiple attempts. Please try again later.")},o.onerror=h=>{console.error("WebSocket error:",h),T("Error connecting to visualization service")}}catch(s){console.error("Error setting up WebSocket:",s),F("disconnected"),T(`Failed to connect: ${s instanceof Error?s.message:String(s)}`)}},[u]);return a.useEffect(()=>(C({crew:null,agents:[],tasks:[]}),m(!1),T(null),p.current&&(p.current.close(),p.current=null),f.current&&(clearTimeout(f.current),f.current=null),w.current&&(clearInterval(w.current),w.current=null),c.current=0,u&&X(u).then(()=>{J()}),()=>{p.current&&(p.current.close(),p.current=null),f.current&&(clearTimeout(f.current),f.current=null),w.current&&(clearInterval(w.current),w.current=null)}),[u,J,X]),a.useEffect(()=>{C({crew:null,agents:[],tasks:[],timestamp:null}),m(!1),T(null),console.log(`State reset triggered by resetKey: ${r}`)},[r]),a.useEffect(()=>{L&&R.length>0&&setTimeout(()=>{L.fitView({padding:.2})},50)},[R.length,L,u,r]),a.useEffect(()=>{var y;if(!d.crew&&!d.agents.length&&!d.tasks.length)return;const s=[],o=[];if(d.crew){const N={id:`crew-${d.crew.id}`,type:"crew",position:{x:0,y:0},data:{...d.crew,hasOutgoingEdge:!1,hasIncomingEdge:!1}};s.push(N)}let h=[];if((y=d.crew)!=null&&y.execution_order&&d.crew.execution_order.length>0){h=d.crew.execution_order.map(v=>d.agents.find(A=>A.id===v)).filter(v=>v!==void 0);const N=new Set(h.map(v=>v.id)),k=d.agents.filter(v=>!N.has(v.id));h=[...h,...k]}else h=[...d.agents];h.forEach((N,k)=>{const v=d.tasks.filter(ae=>ae.agent_id===N.id),A=k===0,D=k===h.length-1,I=!A,W=!D,x={id:`agent-${N.id}`,type:"agent",position:{x:0,y:0},data:{...N,associatedTasks:v,isFirst:A,isLast:D,hasIncomingEdge:I,hasOutgoingEdge:W,executionOrder:k}};s.push(x)});for(let N=0;N<h.length-1;N++){const k=h[N],v=h[N+1],A=`agent-${k.id}`,D=`agent-${v.id}`;let I="#64748b",W=!1;k.status==="completed"?I="#6366f1":k.status==="running"?(I="#10b981",W=!0):k.status==="waiting"&&(I="#f59e0b");const x={id:`agent-${k.id}-to-${v.id}`,source:A,target:D,type:"default",markerEnd:{type:Q.ArrowClosed,color:I},style:{strokeWidth:2,stroke:I},animated:W};o.push(x)}const{nodes:t,edges:z}=Ie(s,o,"TB");i(t),O(z)},[d,i,O]),oe().pathname,(G=d.crew)!=null&&G.id,e.jsxs(je,{className:"p-6 mb-6 overflow-hidden relative",children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Crew Execution Visualization"})}),!b&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/80 dark:bg-slate-900/80 z-10",children:[e.jsx(U,{className:"h-8 w-8 animate-spin text-indigo-500 mb-4"}),e.jsx("h3",{className:"text-lg font-medium",children:B?"Initializing crew...":n?"Waiting for data...":"Loading visualization..."}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:B?"Setting up the crew structure...":n?"The crew execution will appear here once it starts":"Connecting to visualization service..."}),e.jsxs("div",{className:"mt-4 flex items-center space-x-2",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${E==="connected"?"bg-green-500":E==="connecting"?"bg-amber-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs",children:E==="connected"?"Connected":E==="connecting"?"Connecting...":"Disconnected"}),E==="disconnected"&&e.jsx(te,{size:"sm",variant:"outline",onClick:()=>J(),className:"ml-2",children:"Reconnect"})]})]}),S&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4",children:e.jsx("p",{className:"text-sm",children:S})}),e.jsx("div",{className:"h-[600px] border rounded-md overflow-hidden mb-6",ref:j,children:e.jsxs(Ce,{nodes:R,edges:$,onNodesChange:P,onEdgesChange:_,nodeTypes:ne,fitView:!0,fitViewOptions:{padding:.2},attributionPosition:"bottom-right",defaultEdgeOptions:{type:"default",markerEnd:{type:Q.ArrowClosed}},connectionLineType:Se.SmoothStep,proOptions:{hideAttribution:!0},minZoom:.5,maxZoom:1.5,elementsSelectable:!0,onInit:M,children:[e.jsx(ke,{color:"#aaa",gap:16}),e.jsx(Ee,{}),e.jsx(Te,{nodeStrokeWidth:3,zoomable:!0,pannable:!0})]})}),((Y=d.crew)==null?void 0:Y.status)==="completed"&&((Z=d.crew)==null?void 0:Z.output)&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Crew Results"}),e.jsx("div",{className:"p-6 rounded-lg border bg-card overflow-auto",children:e.jsx("div",{className:"text-base leading-7",children:e.jsx(Re,{components:{h1:({...s})=>e.jsx("h1",{className:"text-2xl font-bold mt-6 mb-4",...s}),h2:({...s})=>e.jsx("h2",{className:"text-xl font-bold mt-5 mb-3",...s}),h3:({...s})=>e.jsx("h3",{className:"text-lg font-bold mt-4 mb-2",...s}),p:({...s})=>e.jsx("p",{className:"mb-4",...s}),ul:({...s})=>e.jsx("ul",{className:"list-disc pl-6 mb-4",...s}),ol:({...s})=>e.jsx("ol",{className:"list-decimal pl-6 mb-4",...s}),li:({...s})=>e.jsx("li",{className:"mb-1",...s}),a:({...s})=>e.jsx("a",{className:"text-blue-500 hover:underline",...s}),blockquote:({...s})=>e.jsx("blockquote",{className:"border-l-4 border-muted pl-4 italic my-4",...s}),code:s=>{const{children:o,className:h}=s;return!/language-(\w+)/.exec(h||"")&&(typeof o=="string"?!o.includes(`
`):!0)?e.jsx("code",{className:"bg-muted px-1 py-0.5 rounded",...s,children:o}):e.jsx("pre",{className:"p-4 rounded-md bg-muted overflow-x-auto",children:e.jsx("code",{className:h,children:o})})}},children:d.crew.output})})})]})]})};function Ye(){return[{title:"CrewAI - Kickoff Mode"},{name:"description",content:"Run a crew directly with specific inputs"}]}const Ze=re(function(){ee();const{crews:n,setCrews:r}=ie(),[j,p]=a.useState(!1),[g,c]=a.useState(""),[f,w]=a.useState(null),[d,C]=a.useState([]),[R,i]=a.useState(null),[$,O]=a.useState(null),[L,M]=a.useState(!1),[P,_]=a.useState(0);a.useEffect(()=>{M(!1),O(null),i(null),_(1)},[]),a.useEffect(()=>{(async()=>{try{p(!0);const m=await(await fetch("/api/crews")).json();m.crews&&(r(m.crews),m.crews.length>0&&!g&&c(m.crews[0].id))}catch(b){console.error("Error fetching crews:",b)}finally{p(!1)}})()},[r,g]),a.useEffect(()=>{(async()=>{if(!g){w(null),C([]);return}try{p(!0);const m=await(await fetch(`/api/initialize?crew_id=${g}`)).json();if(m.status==="success"){const S=n.find(T=>T.id===g);S&&(w({id:S.id,name:S.name,description:S.description,required_inputs:m.required_inputs||[]}),C((m.required_inputs||[]).map(T=>({name:T.name,description:T.description,value:""}))))}else i(m.detail||"Failed to fetch crew details")}catch(b){console.error("Error fetching crew details:",b),i("Failed to fetch crew details. Please try again later.")}finally{p(!1)}})()},[g,n]);const E=(l,b)=>{C(m=>m.map(S=>S.name===l?{...S,value:b}:S))},F=async l=>{if(l.preventDefault(),!g)return;p(!0),i(null),O(null),M(!0),_(m=>m+1);const b={};d.forEach(m=>{b[m.name]=m.value});try{const S=await(await fetch(`/api/crews/${g}/kickoff`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inputs:b})})).json();S.status==="success"||i(S.detail||"Failed to run crew")}catch(m){console.error("Error running crew:",m),i("Failed to run crew. Please try again later.")}finally{p(!1)}},B=e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Select a Crew"}),e.jsxs(me,{value:g,onValueChange:c,disabled:j,children:[e.jsx(ge,{id:"crew-select",className:"w-full",children:e.jsx(he,{placeholder:"Select a crew"})}),e.jsx(pe,{children:n.map(l=>e.jsx(fe,{value:l.id,children:l.name},l.id))})]})]}),f&&e.jsxs("div",{className:"p-4 rounded-lg border bg-accent/50",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:f.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:f.description})]}),d.length>0&&e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Required Inputs"}),d.map(l=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs(le,{htmlFor:l.name,className:"text-sm font-medium",children:[l.name,l.description&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 block mt-1",children:l.description})]}),l.description.toLowerCase().includes("longer")?e.jsx(de,{id:l.name,value:l.value,onChange:b=>E(l.name,b.target.value),disabled:j,className:"min-h-24 text-sm"}):e.jsx(ue,{id:l.name,value:l.value,onChange:b=>E(l.name,b.target.value),disabled:j,className:"text-sm"})]},l.name)),e.jsx(te,{type:"submit",className:"w-full",disabled:j||d.some(l=>!l.value),children:j?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}),"Running Crew..."]}):"Run Crew"})]})]});return e.jsxs(ce,{rightSidebar:B,children:[R&&e.jsxs(we,{variant:"destructive",className:"mb-6",children:[e.jsx(be,{children:"Error"}),e.jsx(ye,{children:R})]}),g&&e.jsx(xe,{crewId:g}),g&&e.jsx(ze,{crewId:g,isRunning:L,resetKey:P}),!R&&!g&&e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Run a Crew Directly"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Select a crew from the sidebar, provide the required inputs, and run it to see results here."}),j&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx(U,{className:"h-8 w-8 animate-spin text-primary"})})]})})]})});export{Ze as default,Ye as meta};
