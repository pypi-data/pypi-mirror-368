# https://github.com/microsoft/vscode-dev-containers/blob/main/containers/python-3/.devcontainer/Dockerfile

# [Choice] Python version (use -bullseye variants on local arm64/Apple Silicon): 3, 3.10, 3.9, 3.8, 3.7, 3.6, 3-bullseye, 3.10-bullseye, 3.9-bullseye, 3.8-bullseye, 3.7-bullseye, 3.6-bullseye, 3-buster, 3.10-buster, 3.9-buster, 3.8-buster, 3.7-buster, 3.6-buster
ARG VARIANT=3-bullseye
FROM mcr.microsoft.com/vscode/devcontainers/python:${VARIANT}

# [Choice] Node.js version: none, lts/*, 16, 14, 12, 10
ARG NODE_VERSION="none"
RUN if [ "${NODE_VERSION}" != "none" ]; then su vscode -c "umask 0002 && . /usr/local/share/nvm/nvm.sh && nvm install ${NODE_VERSION} 2>&1"; fi

ARG USERNAME=vscode

# Allow non-root user to run docker commands

RUN groupadd -f docker && usermod -aG docker ${USERNAME}

# Switch to non-root user

USER $USERNAME
ARG PROJECT_NAME
ARG PROJECT_DIR="/workspaces/${PROJECT_NAME}"
ENV PROJECT_DIR=${PROJECT_DIR}

# 16 - Install Ollama client
RUN curl -fsSL https://ollama.com/install.sh | sh

# 17 - Install uv

WORKDIR ${PROJECT_DIR}
RUN echo "whoami " && whoami
COPY --from=ghcr.io/astral-sh/uv@sha256:2381d6aa60c326b71fd40023f921a0a3b8f91b14d5db6b90402e65a635053709 /uv /uvx /bin/
ARG CACHE_BUST_UV="0.0.2"
ARG UV_PROJECT_ENVIRONMENT=${PROJECT_DIR}/.venv
ENV UV_PROJECT_ENVIRONMENT=$UV_PROJECT_ENVIRONMENT
ENV VIRTUAL_ENV=$UV_PROJECT_ENVIRONMENT
ENV PATH=$UV_PROJECT_ENVIRONMENT/bin:$PATH
RUN echo ">>> Export UV_PROJECT_ENVIRONMENT=${UV_PROJECT_ENVIRONMENT}"
RUN echo ">>> Installing virtual environment in path ${PROJECT_DIR}"
RUN uv venv

# 18 - Install Claude Code

RUN npm install -g @anthropic-ai/claude-code

# 19 - Setup GAI

RUN echo "{\"app_dir\":\"${HOME}/.gai\"}" > ${HOME}/.gairc && \
    mkdir -p ${HOME}/.gai
SHELL ["/bin/bash","-c"]

# 20 - Startup

RUN mkdir /workspaces/projects

