import{d as k,k as H,e as A,l as n,m as s,n as M,p as y,q as u,s as O,B as b,D as r,M as I,G as c,F as P,U as E,a$ as R,V as D,Z as v,$ as x,ap as S,g as h,E as _,bp as j,bc as Z,aK as $,w,N as B}from"./jwt-decode.esm-Dca5fHH5.js";import{t as F}from"./ant-design-12Ybi1Rk.js";import{c as T}from"./string-BYR4BIXr.js";import{I as C}from"./PhCopy.vue-DigtJVV6.js";import{e as L,f as N}from"./router-D5wfdag3.js";import{S as z}from"./index-ZQBk4l6i.js";import{b as q}from"./build-B7ZDvyug.js";import"./tables-BsqTY_wE.js";import{e as G}from"./repository-Csx9zlUA.js";import{u as J}from"./polling-CKeyL76l.js";(function(){try{var p=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(p._sentryDebugIds=p._sentryDebugIds||{},p._sentryDebugIds[t]="e13882a1-a7f2-4b04-b7ca-192ede4ee15b",p._sentryDebugIdIdentifier="sentry-dbid-e13882a1-a7f2-4b04-b7ca-192ede4ee15b")}catch{}})();const U=["width","height","fill","transform"],W={key:0},Q=u("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),X=[Q],Y={key:1},K=u("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),tt=u("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),et=[K,tt],at={key:2},st=u("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),it=[st],ot={key:3},rt=u("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),nt=[rt],lt={key:4},ct=u("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),dt=[ct],pt={key:5},ht=u("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),ut=[ht],gt={name:"PhRobot"},ft=k({...gt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(p){const t=p,i=H("weight","regular"),a=H("size","1em"),o=H("color","currentColor"),l=H("mirrored",!1),d=A(()=>t.weight??i),e=A(()=>t.size??a),g=A(()=>t.color??o),f=A(()=>t.mirrored!==void 0?t.mirrored?"scale(-1, 1)":void 0:l?"scale(-1, 1)":void 0);return(m,V)=>(s(),n("svg",O({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:e.value,height:e.value,fill:g.value,transform:f.value},m.$attrs),[M(m.$slots,"default"),d.value==="bold"?(s(),n("g",W,X)):d.value==="duotone"?(s(),n("g",Y,et)):d.value==="fill"?(s(),n("g",at,it)):d.value==="light"?(s(),n("g",ot,nt)):d.value==="regular"?(s(),n("g",lt,dt)):d.value==="thin"?(s(),n("g",pt,ut)):y("",!0)],16,U))}}),mt={key:0,class:"cli"},yt={key:0},bt=k({__name:"LogContainer",props:{logs:{}},setup(p){return(t,i)=>(s(),b(r(I),{vertical:"",gap:"small"},{default:c(()=>[t.logs.entries.length?(s(),n("div",mt,[(s(!0),n(P,null,E(t.logs.entries,a=>(s(),n("p",{key:a.createdAt,style:R({margin:0,"white-space":"pre-wrap",color:a.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[a.payload.text?(s(),n("span",yt,D(a.payload.text.trim()),1)):y("",!0)],4))),128))])):(s(),b(r(v),{key:1,type:"secondary"},{default:c(()=>[x("Empty")]),_:1}))]),_:1}))}}),St=S(bt,[["__scopeId","data-v-b7f04a41"]]),xt={key:0},Ht=["onClick"],At=["onClick"],Zt=k({__name:"ExecutionContext",props:{data:{},failed:{type:Boolean}},emits:["ask-ai"],setup(p,{emit:t}){const i=e=>{if(e==="legacyThreadData")return"Thread data";const g=T(e);return g.replace(/([A-Z])/g," $1").trim(),g},a=e=>e==null?!0:Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1,o=e=>{typeof e=="object"&&e!==null&&"payload"in e?(navigator.clipboard.writeText(JSON.stringify(e.payload)),Z.success({content:"Copied to clipboard"})):(navigator.clipboard.writeText(""),Z.error({content:"No payload to copy"}))},l=e=>{e.stopPropagation(),t("ask-ai")},d=e=>{typeof e=="object"?(navigator.clipboard.writeText(JSON.stringify(e)),Z.success({content:"Copied to clipboard"})):(navigator.clipboard.writeText(""),Z.error({content:"Failed to copy request"}))};return(e,g)=>(s(),b(r(L),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:c(()=>[h(r(N),{key:"execution-context"},{header:c(()=>[h(r(I),{justify:"space-between"},{default:c(()=>[h(r(v),null,{default:c(()=>[x("Execution context")]),_:1}),e.failed?(s(),n("div",{key:0,class:"ask-to-ai",onClick:l},[x(" Fix with AI "),h(r(ft),{size:16})])):y("",!0)]),_:1})]),default:c(()=>[h(r(z),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:c(()=>[Object.keys(e.data).length?(s(!0),n(P,{key:1},E(Object.entries(e.data),([f,m])=>(s(),n("div",{key:f,class:"tree"},[f!=="legacyThreadData"||!a(m)?(s(),n("div",xt,[h(r(v),{strong:""},{default:c(()=>[x(D(i(f)),1)]),_:2},1024),f==="request"?(s(),b(r(_),{key:0,title:"Copy Request Data"},{default:c(()=>[u("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:V=>d(m)},[h(r(C))],8,Ht)]),_:2},1024)):y("",!0),f==="triggerTask"?(s(),b(r(_),{key:1,title:"Copy Payload Data"},{default:c(()=>[u("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:V=>o(m)},[h(r(C))],8,At)]),_:2},1024)):y("",!0),h(r(j),{"tree-data":r(F)(m),selectable:!1},null,8,["tree-data"])])):y("",!0)]))),128)):(s(),b(r(v),{key:0,type:"secondary"},{default:c(()=>[x("Empty")]),_:1}))]),_:1})]),_:1})]),_:1}))}}),Tt=S(Zt,[["__scopeId","data-v-18e9fc92"]]);class Mt{constructor(t,i,a,o,l,d,e){this.executionRepository=t,this.buildRepository=i,this.projectId=a,this.onFilterChange=e,this.state=$({currentPage:{openedExecutionIds:d?[d]:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}},pagination:{currentIndex:1,pageSize:10,totalCount:0,...l},filters:{dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0,...o},filterOptions:{builds:[],stages:[],statuses:G.map(g=>({label:T(g),value:g}))}}),w(()=>this.state.filters.buildId,()=>{this.fetchStageOptions()}),w(this.state.filters,()=>{this.state.currentPage.openedExecutionIds=[],this.handleFilterChange()}),w(this.state.pagination,()=>{this.state.currentPage.openedExecutionIds=[],this.fetchPage()})}state;polling=J({task:()=>this.refetch(),interval:1e4});async init(){await Promise.all([this.fetchPage(),this.fetchOptions()]),this.fetchEmptyLogs(),this.polling.startPolling()}teardown(){this.polling.endPolling()}async getNewestExecutionId(t){let i=this.state.currentPage.executions;return t&&(i=i.filter(o=>o.stageId===t)),i.length===0?null:i.reduce((o,l)=>o.createdAt>l.createdAt?o:l).id}handleFilterChange=()=>{this.state.currentPage.waitingDebounce=!0,this.state.pagination.currentIndex=1,this.debouncedPageRefetch(),this.onFilterChange&&this.onFilterChange(this.state.filters)};debouncedPageRefetch=B.debounce(async()=>{await this.fetchPage(),this.state.currentPage.waitingDebounce=!1},500);async fetchPage(){this.state.currentPage.loadingExecutions=!0;const{executions:t,totalCount:i}=await this.executionRepository.list({projectId:this.projectId,buildId:this.state.filters.buildId,status:this.state.filters.status,limit:this.state.pagination.pageSize,offset:(this.state.pagination.currentIndex-1)*this.state.pagination.pageSize,stageId:this.state.filters.stageId,startDate:this.state.filters.dateRange?.[0]?.toISOString(),endDate:this.state.filters.dateRange?.[1]?.toISOString(),search:this.state.filters.search});this.state.currentPage.loadingExecutions=!1,this.state.currentPage.executions=t,this.state.pagination.totalCount=i}async fetchBuildOptions(){if(!this.buildRepository)return;const i=(await this.buildRepository.list(this.projectId)).map(a=>({label:`[${a.id.slice(0,8)}] ${a.createdAt.toLocaleString()} ${a.latest?"(Latest)":""}`,value:a.id}));this.state.filterOptions.builds=i}async fetchStageOptions(){if(!this.buildRepository){const o=(await this.executionRepository.fetchStages()).map(l=>({label:l.title,value:l.id}));this.state.filterOptions.stages=o??[];return}const i=(await q.get(this.state.filters.buildId??this.state.filterOptions.builds[0].value))?.runtimes.map(a=>({label:a.title,value:a.id}));this.state.filterOptions.stages=i??[]}async fetchOptions(){await this.fetchBuildOptions(),await this.fetchStageOptions()}async fetchExecutionDetails(t){const[i,a,o]=await Promise.all([this.executionRepository.fetchLogs(this.projectId,t),this.executionRepository.fetchThreadData(this.projectId,t),this.executionRepository.getExecutionTasks(this.projectId,t)]);this.state.currentPage.executionData[t]={logs:i,threadData:a,tasks:{triggerTask:o.triggerTask?{type:o.triggerTask.type,payload:o.triggerTask.payload}:null,sentTasks:o.sentTasks.map(l=>({type:l.type,payload:l.payload}))}}}fetchEmptyLogs=()=>{this.state.currentPage.openedExecutionIds.forEach(async t=>{this.state.currentPage.executionData[t]||await this.fetchExecutionDetails(t)})};async refetch(){this.state.currentPage.openedExecutionIds.map(t=>this.fetchExecutionDetails(t))}}export{Mt as L,Tt as T,St as a};
//# sourceMappingURL=LogsController-DHyhzx37.js.map
