{"version":3,"file":"Home-Cxo9z51q.js","sources":["../../src/apps/editor/views/webEditor/watcher.ts","../../src/apps/editor/views/Home.vue"],"sourcesContent":["import { AbstraLibApiEditorWebEditorResponse } from '@/contracts.generated';\nimport localFetch from '@/utils/fetch';\nimport { usePolling } from '@/utils/polling';\nimport { ref } from 'vue';\nimport { Router } from 'vue-router';\n\nconst HEALTH_CHECK_HISTORY_SIZE = 4;\n\nexport const useWebEditorWatcher = (dep: { router: Router }) => {\n  const router = dep.router;\n  const waitingRoomUrl = ref('');\n\n  const healthCheckHistory = ref<boolean[]>(Array(HEALTH_CHECK_HISTORY_SIZE).fill(true));\n  let currentIndex = 0;\n\n  const checkHealth = async () => {\n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 1000); // 1 second\n\n      const response = await localFetch('/_healthcheck', {\n        method: 'GET',\n        signal: controller.signal,\n        headers: {\n          'Content-Type': 'application/json',\n          'Cache-Control': 'no-cache',\n        },\n      });\n\n      clearTimeout(timeoutId);\n\n      healthCheckHistory.value[currentIndex] = response.status === 200;\n    } catch (e) {\n      healthCheckHistory.value[currentIndex] = false;\n    }\n\n    currentIndex = (currentIndex + 1) % HEALTH_CHECK_HISTORY_SIZE;\n\n    if (healthCheckHistory.value.every((status) => !status) && waitingRoomUrl.value) {\n      const currentPath = router.currentRoute.value.path;\n      const queryParams = new URLSearchParams();\n      queryParams.set('redirect', currentPath);\n      window.location.href = waitingRoomUrl.value + '?' + queryParams.toString();\n    }\n  };\n\n  const { startPolling, endPolling } = usePolling({\n    task: checkHealth,\n    interval: 2000,\n  });\n\n  const setup = async () => {\n    const response = await localFetch(`/_editor/api/web-editor/`, {\n      method: 'GET',\n    });\n\n    if (!response.ok) {\n      setTimeout(() => {\n        setup();\n      }, 1000);\n      return;\n    }\n\n    const res = (await response.json()) as AbstraLibApiEditorWebEditorResponse;\n\n    if (res.waitingRoomUrl) {\n      waitingRoomUrl.value = res.waitingRoomUrl;\n      startPolling();\n    }\n  };\n\n  return {\n    setup,\n    cleanUp: endPolling,\n  };\n};\n","<template>\n  <RouterView class=\"router\" />\n</template>\n<script setup lang=\"ts\">\nimport { onMounted, onUnmounted } from 'vue';\nimport { useRouter } from 'vue-router';\nimport { useWebEditorWatcher } from './webEditor/watcher';\n\nconst router = useRouter();\nconst { setup, cleanUp } = useWebEditorWatcher({ router });\n\nonMounted(() => {\n  setup();\n});\n\nonUnmounted(() => {\n  cleanUp();\n});\n</script>\n<style scoped lang=\"scss\">\n.home {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  height: 100vh;\n  width: 100vw;\n}\n\n.router {\n  height: 100%;\n  width: 100%;\n}\n</style>\n"],"names":["HEALTH_CHECK_HISTORY_SIZE","useWebEditorWatcher","dep","router","waitingRoomUrl","ref","healthCheckHistory","currentIndex","checkHealth","controller","timeoutId","response","localFetch","status","currentPath","queryParams","startPolling","endPolling","usePolling","setup","res","useRouter","cleanUp","onMounted","onUnmounted"],"mappings":"ofAMA,MAAMA,EAA4B,EAErBC,EAAuBC,GAA4B,CAC9D,MAAMC,EAASD,EAAI,OACbE,EAAiBC,EAAI,EAAE,EAEvBC,EAAqBD,EAAe,MAAML,CAAyB,EAAE,KAAK,EAAI,CAAC,EACrF,IAAIO,EAAe,EAEnB,MAAMC,EAAc,SAAY,CAC9B,GAAI,CACF,MAAMC,EAAa,IAAI,gBACjBC,EAAY,WAAW,IAAMD,EAAW,MAAA,EAAS,GAAI,EAErDE,EAAW,MAAMC,EAAW,gBAAiB,CACjD,OAAQ,MACR,OAAQH,EAAW,OACnB,QAAS,CACP,eAAgB,mBAChB,gBAAiB,UAAA,CACnB,CACD,EAED,aAAaC,CAAS,EAEtBJ,EAAmB,MAAMC,CAAY,EAAII,EAAS,SAAW,GAC/D,MAAY,CACVL,EAAmB,MAAMC,CAAY,EAAI,EAC3C,CAIA,GAFAA,GAAgBA,EAAe,GAAKP,EAEhCM,EAAmB,MAAM,MAAOO,GAAW,CAACA,CAAM,GAAKT,EAAe,MAAO,CAC/E,MAAMU,EAAcX,EAAO,aAAa,MAAM,KACxCY,EAAc,IAAI,gBACxBA,EAAY,IAAI,WAAYD,CAAW,EACvC,OAAO,SAAS,KAAOV,EAAe,MAAQ,IAAMW,EAAY,SAAA,CAClE,CACF,EAEM,CAAE,aAAAC,EAAc,WAAAC,CAAA,EAAeC,EAAW,CAC9C,KAAMV,EACN,SAAU,GAAA,CACX,EAEKW,EAAQ,SAAY,CACxB,MAAMR,EAAW,MAAMC,EAAW,2BAA4B,CAC5D,OAAQ,KAAA,CACT,EAED,GAAI,CAACD,EAAS,GAAI,CAChB,WAAW,IAAM,CACfQ,EAAA,CACF,EAAG,GAAI,EACP,MACF,CAEA,MAAMC,EAAO,MAAMT,EAAS,KAAA,EAExBS,EAAI,iBACNhB,EAAe,MAAQgB,EAAI,eAC3BJ,EAAA,EAEJ,EAEA,MAAO,CACL,MAAAG,EACA,QAASF,CAAA,CAEb,8BCnEA,MAAMd,EAASkB,EAAA,EACT,CAAE,MAAAF,EAAO,QAAAG,CAAA,EAAYrB,EAAoB,CAAE,OAAAE,EAAQ,EAEzD,OAAAoB,EAAU,IAAM,CACdJ,EAAA,CACF,CAAC,EAEDK,EAAY,IAAM,CAChBF,EAAA,CACF,CAAC"}