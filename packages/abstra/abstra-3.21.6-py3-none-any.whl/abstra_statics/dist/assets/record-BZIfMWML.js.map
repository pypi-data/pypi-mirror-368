{"version":3,"file":"record-BZIfMWML.js","sources":["../../src/utils/pubsub.ts","../../src/utils/record.ts"],"sourcesContent":["type Token = string;\n\ntype Topics<T extends Record<string, unknown>> = {\n  [K in keyof T]: {\n    token: string;\n    func: (args: T[K]) => void;\n  }[];\n};\n\nexport class PubSub<T extends Record<string, unknown>> {\n  private topics: Topics<T>;\n  private subUid: number;\n\n  constructor() {\n    this.topics = {} as Topics<T>;\n    this.subUid = -1;\n  }\n\n  public subscribe<K extends keyof T>(topic: K, func: (args: T[K]) => unknown): Token {\n    const token = (++this.subUid).toString();\n    if (!this.topics[topic]) {\n      this.topics[topic] = [];\n    }\n    this.topics[topic].push({\n      token: token,\n      func: func,\n    });\n    return token;\n  }\n\n  public async wait<K extends keyof T>(topic: K): Promise<T[K]> {\n    return new Promise<T[K]>((resolve) => {\n      const token = this.subscribe(topic, (args) => {\n        this.unsubscribe(token);\n        resolve(args as T[K]);\n      });\n    });\n  }\n\n  public async publish<K extends keyof T>(\n    topic: K,\n    ...args: T[K] extends undefined ? [undefined?] : [T[K]]\n  ) {\n    if (!this.topics[topic]) {\n      return false;\n    }\n    const subscribers = this.topics[topic];\n    let len = subscribers ? subscribers.length : 0;\n\n    while (len--) {\n      await subscribers[len].func(args[0]!);\n    }\n    return true;\n  }\n\n  public unsubscribe(token: Token) {\n    for (const m in this.topics) {\n      if (this.topics[m]) {\n        for (let i = 0, j = this.topics[m].length; i < j; i++) {\n          if (this.topics[m][i].token === token) {\n            this.topics[m].splice(i, 1);\n            return token;\n          }\n        }\n      }\n    }\n    return false;\n  }\n\n  public reset() {\n    this.topics = {} as Topics<T>;\n    this.subUid = -1;\n  }\n}\n","import { PubSub } from '@/utils/pubsub';\nimport { isEqual, debounce } from 'lodash';\nimport { markRaw, ShallowRef, shallowRef } from 'vue';\n\ntype ID = string | null;\n\ntype IdDTO = Record<string, any> & { id: ID };\n\ninterface UpdateApi<S extends IdDTO> {\n  update(id: ID, dto: Partial<S>): Promise<any>;\n}\n\nexport class EditableRecord<S extends Record<string, any>> {\n  public initialState: S;\n  public pubsub: PubSub<{ update: Partial<S> }>;\n  protected _changes: ShallowRef<Partial<S>>;\n\n  protected constructor(initialState: S) {\n    this.initialState = initialState;\n    this.pubsub = new PubSub();\n    this._changes = shallowRef<Partial<S>>({});\n  }\n\n  static from<T extends Record<string, any>>(initialState: T) {\n    return markRaw(new EditableRecord(initialState));\n  }\n\n  get changes() {\n    return this._changes.value;\n  }\n\n  get<K extends keyof S>(key: K): S[K] {\n    return this.changes[key] ?? this.initialState[key];\n  }\n\n  set<K extends keyof S>(key: K, value: S[K]): void {\n    this._changes.value = { ...this.changes, [key]: value };\n  }\n\n  hasChanges(key?: keyof S): boolean {\n    if (key) {\n      return key in this.changes;\n    } else {\n      return Object.keys(this.changes).length > 0;\n    }\n  }\n\n  hasChangesDeep(key: keyof S): boolean {\n    return key in this.changes && !isEqual(this.initialState[key], this.changes[key]);\n  }\n\n  get state(): S {\n    return { ...this.initialState, ...this.changes };\n  }\n\n  resetChanges() {\n    const eventArgs = { ...this.changes };\n    this._changes.value = {};\n    this.pubsub.publish('update', eventArgs as any);\n  }\n\n  onUpdate(callback: (changes?: Partial<S>) => void): void {\n    this.pubsub.subscribe('update', callback);\n  }\n\n  commit() {\n    this.initialState = this.state;\n    this._changes.value = {};\n  }\n\n  toDTO(): S {\n    return { ...this.state, ...this._changes.value };\n  }\n\n  update(dto: Partial<S>) {\n    this._changes.value = { ...this.changes, ...dto };\n  }\n}\n\nexport class ActiveRecord<S extends IdDTO> extends EditableRecord<S> {\n  private api: UpdateApi<S>;\n\n  private constructor(api: UpdateApi<S>, initialState: S) {\n    super(initialState);\n    this.api = api;\n  }\n\n  static create<T extends IdDTO>(api: UpdateApi<T>, initialState: T) {\n    return markRaw(new ActiveRecord(api, initialState));\n  }\n\n  getInitialState<K extends keyof S>(key: K): S[K] {\n    return this.initialState[key];\n  }\n\n  updateInitialState(key: keyof S, value: S[typeof key]) {\n    this.initialState[key] = value;\n    delete this._changes.value[key];\n  }\n\n  async save(key?: keyof S): Promise<void> {\n    if (Object.keys(this.changes).length === 0) return;\n\n    if (key && !(key in this.changes)) return;\n    if (key) {\n      const keyChange = { [key]: this.changes[key] } as Partial<S>;\n      const keyUpdated = await this.api.update(this.initialState.id, keyChange);\n      this.initialState = { ...this.initialState, ...keyUpdated };\n      delete this._changes.value[key];\n      return;\n    }\n\n    this.initialState = await this.api.update(this.initialState.id, this.changes);\n    const eventArgs = { ...this.changes };\n    this._changes.value = {};\n    this.pubsub.publish('update', eventArgs as any);\n  }\n}\n\nexport class AutoSavableActiveRecord<S extends IdDTO> extends EditableRecord<S> {\n  private api: UpdateApi<S>;\n  private debouncedSave: () => void;\n\n  private constructor(api: UpdateApi<S>, initialState: S) {\n    super(initialState);\n    this.api = api;\n    this.debouncedSave = debounce(() => {\n      this.save();\n    }, 500);\n  }\n\n  static create<T extends IdDTO>(api: UpdateApi<T>, initialState: T) {\n    return markRaw(new AutoSavableActiveRecord(api, initialState));\n  }\n\n  getInitialState<K extends keyof S>(key: K): S[K] {\n    return this.initialState[key];\n  }\n\n  updateInitialState(key: keyof S, value: S[typeof key]) {\n    this.initialState[key] = value;\n    delete this._changes.value[key];\n  }\n\n  set<K extends keyof S>(key: K, value: S[K]): void {\n    super.set(key, value);\n    this.debouncedSave();\n  }\n\n  async save(key?: keyof S): Promise<void> {\n    if (Object.keys(this.changes).length === 0) return;\n\n    if (key && !(key in this.changes)) return;\n    if (key) {\n      const keyChange = { [key]: this.changes[key] } as Partial<S>;\n      const keyUpdated = await this.api.update(this.initialState.id, keyChange);\n      this.initialState = { ...this.initialState, ...keyUpdated };\n      delete this._changes.value[key];\n      return;\n    }\n\n    this.initialState = await this.api.update(this.initialState.id, this.changes);\n    const eventArgs = { ...this.changes };\n    this._changes.value = {};\n    this.pubsub.publish('update', eventArgs as any);\n  }\n}\n"],"names":["PubSub","topic","func","token","resolve","args","subscribers","len","m","j","EditableRecord","initialState","shallowRef","markRaw","key","value","isEqual","eventArgs","callback","dto","ActiveRecord","api","keyChange","keyUpdated","AutoSavableActiveRecord","debounce"],"mappings":"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"}