{"version":3,"file":"Login-CCkwUShi.js","sources":["../../src/apps/console/authn/Passwordless.vue","../../src/apps/console/views/Login.vue"],"sourcesContent":["<template>\n  <div class=\"form\">\n    <div class=\"header\">\n      <AbstraLogo hide-text size=\"large\" />\n      <h2>\n        {{\n          i18nProvider.translate('i18n_auth_validate_your_email_login', null, {\n            brandName: 'Abstra',\n          })\n        }}\n      </h2>\n    </div>\n    <AForm v-if=\"state.stage === 'collect-info'\" class=\"section\">\n      <div class=\"description\">\n        {{ i18nProvider.translate('i18n_auth_info_description') }}\n      </div>\n      <AFormItem\n        has-feedback\n        :validate-status=\"state.invalid ? 'error' : ''\"\n        :help=\"state.invalid ? i18nProvider.translate('i18n_auth_info_invalid_email') : ''\"\n      >\n        <AInput\n          type=\"email\"\n          :value=\"state.info.email\"\n          :placeholder=\"i18nProvider.translate('i18n_auth_enter_your_work_email')\"\n          autofocus\n          @blur=\"validateEmail\"\n          @keyup.enter=\"() => collectInfo()\"\n          @change=\"updateEmailToLowerCase($event.target.value)\"\n        />\n      </AFormItem>\n      <AButton type=\"primary\" @click=\"() => collectInfo()\">\n        {{ i18nProvider.translate('i18n_auth_info_send_code') }}\n      </AButton>\n    </AForm>\n    <AForm v-else-if=\"state.stage === 'collect-token'\" class=\"section\">\n      <div class=\"description\">\n        {{ i18nProvider.translate('i18n_auth_token_label', null, state.info) }}\n      </div>\n      <AFormItem has-feedback :validate-status=\"state.invalid ? 'error' : ''\">\n        <OTPInput\n          v-model:value=\"state.token\"\n          :length=\"6\"\n          :numeric=\"true\"\n          size=\"large\"\n          @collect-token=\"collectToken\"\n        />\n        <AntAlert\n          v-if=\"state.invalid\"\n          :message=\"i18nProvider.translate('i18n_auth_token_invalid')\"\n          type=\"error\"\n          style=\"margin-top: 24px\"\n        />\n      </AFormItem>\n      <AButton type=\"primary\" @click=\"collectToken\">\n        {{ i18nProvider.translate('i18n_auth_token_verify_email') }}\n      </AButton>\n      <AButton @click=\"restartAuth\">\n        {{ i18nProvider.translate('i18n_auth_edit_email') }}\n      </AButton>\n      <AButton :disabled=\"!!state.secsToAllowResend\" @click=\"resendToken\">\n        {{ i18nProvider.translate('i18n_auth_token_resend_email') }} ({{ state.secsToAllowResend }}\n        s)\n      </AButton>\n      <div class=\"footer\">\n        {{ i18nProvider.translate('i18n_auth_token_footer_alternative_email') }}\n      </div>\n    </AForm>\n    <div v-else-if=\"state.stage === 'loading'\" class=\"loading\">\n      <LoadingIndicator />\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport AbstraLogo from '@/components/AbstraLogo.vue';\nimport OTPInput from '@/components/inputs/OTPInput.vue';\nimport { isEmail } from '@/utils/string';\nimport LoadingIndicator from '@/widgets-lib/common/components/CircularLoading.vue';\nimport { i18nProvider } from '@/widgets-lib/common/i18n';\nimport {\n  Button as AButton,\n  Form as AForm,\n  FormItem as AFormItem,\n  Input as AInput,\n  Alert as AntAlert,\n} from 'ant-design-vue';\nimport { ref } from 'vue';\nimport { Tracking } from '../apis/tracking';\n\nimport { PasswordlessAuthor, authorManager } from './authorManager';\n\nconst emits = defineEmits<{\n  (e: 'done', user: PasswordlessAuthor): void;\n}>();\n\ntype AuthState = {\n  stage: 'collect-info' | 'collect-token' | 'loading' | 'done';\n  info: { email: string };\n  token: string;\n  invalid: boolean;\n  secsToAllowResend: number;\n};\n\nconst state = ref<AuthState>({\n  stage: 'collect-info',\n  info: { email: '' },\n  token: '',\n  invalid: false,\n  secsToAllowResend: 0,\n});\n\nfunction validateEmail(): boolean {\n  const email = state.value.info.email;\n  const isEmailValid = isEmail(email);\n\n  state.value.invalid = !isEmailValid;\n  return isEmailValid;\n}\n\nlet interval: ReturnType<typeof setInterval>;\nconst collectInfo = async ({ isResend }: { isResend?: boolean } = {}) => {\n  if (!validateEmail()) {\n    return;\n  }\n\n  state.value.stage = 'loading';\n\n  try {\n    await authorManager.authenticate(state.value.info.email, isResend);\n    state.value.stage = 'collect-token';\n    state.value.secsToAllowResend = 120;\n    clearInterval(interval);\n    interval = setInterval(() => {\n      state.value.secsToAllowResend -= 1;\n      if (state.value.secsToAllowResend <= 0) {\n        clearInterval(interval);\n      }\n    }, 1000);\n  } catch (error) {\n    state.value.invalid = true;\n    state.value.stage = 'collect-info';\n  }\n};\n\nconst updateEmailToLowerCase = (value?: string) => {\n  if (!value) {\n    state.value.info.email = '';\n    return;\n  }\n  state.value.info.email = value.toLowerCase();\n};\n\nconst collectToken = async () => {\n  if (!state.value.info?.email) return;\n  state.value.stage = 'loading';\n\n  try {\n    const user = await authorManager.verify(state.value.info.email, state.value.token);\n    if (!user) throw new Error('[Passwordless] Login did not return an user');\n    Tracking.trackSession();\n    emits('done', user);\n    state.value.stage = 'done';\n  } catch (e) {\n    state.value.invalid = true;\n    state.value.stage = 'collect-token';\n  }\n};\n\nconst notifyResendToken = async (email: string) => {\n  await fetch(`https://admin.abstra.app/_hooks/notify-email-not-received?email=${email}`, {\n    method: 'GET',\n  });\n};\n\nconst resendToken = () => {\n  if (state.value.info) {\n    collectInfo({ isResend: true });\n    notifyResendToken(state.value.info.email);\n  }\n};\n\nconst restartAuth = () => {\n  state.value.stage = 'collect-info';\n  state.value.info = { email: '' };\n  state.value.token = '';\n  state.value.invalid = false;\n};\n</script>\n\n<style scoped lang=\"scss\">\n@import '@/styles/index.scss';\n\n.form {\n  align-items: center;\n  justify-content: center;\n  background-color: #fff;\n  width: 400px;\n  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);\n  gap: 10px;\n  border-radius: 8px;\n  padding: 40px 80px;\n  font-family: 'DM Sans', sans-serif;\n\n  .header {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 10px;\n    margin: 25px auto 25px auto;\n\n    h2 {\n      font-size: 24px;\n      font-weight: 500;\n      padding: 0px;\n      margin: 0px;\n      font-family: 'DM Sans', sans-serif;\n    }\n  }\n\n  .section {\n    display: flex;\n    flex-direction: column;\n    gap: 20px;\n\n    .description {\n      font-size: 16px;\n      font-weight: 400;\n      text-align: center;\n    }\n\n    .footer {\n      font-size: 14px;\n      font-weight: 400;\n      text-align: center;\n    }\n  }\n}\n\n.loading {\n  display: flex;\n  justify-content: center;\n}\n</style>\n","<template>\n  <div v-if=\"shouldShowLoginPage\" class=\"login\">\n    <Passwordless @done=\"done\" />\n  </div>\n  <div v-else class=\"loading\">\n    <LoadingIndicator />\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport LoadingIndicator from '@/widgets-lib/common/components/CircularLoading.vue';\nimport { computed, onBeforeMount } from 'vue';\nimport { useRoute, useRouter } from 'vue-router';\nimport { AuthorAPI } from '../apis/cloud/author';\nimport Passwordless from '../authn/Passwordless.vue';\nimport { authorManager } from '../authn/authorManager';\n\nconst router = useRouter();\nconst route = useRoute();\n\nasync function done() {\n  const redirectUrl = route.query['redirect'] as string | null;\n  const prevRedirectUrl = route.query['prev-redirect'] as string | null;\n\n  const { status } = await AuthorAPI.getInfo();\n\n  if (status !== 'active') {\n    router.push({\n      name: 'onboarding',\n      query: {\n        redirect: redirectUrl,\n        'prev-redirect': prevRedirectUrl,\n      },\n    });\n    return;\n  }\n\n  if (redirectUrl) {\n    const redirectPath = redirectUrl.split('/').at(-1);\n    await router.push({\n      path: redirectPath,\n      query: {\n        ...route.query,\n        redirect: prevRedirectUrl,\n        'prev-redirect': undefined,\n      },\n    });\n    return;\n  }\n\n  router.push({ name: 'home' });\n}\n\nconst shouldShowLoginPage = computed(() => {\n  return !authorManager.getAuthor();\n});\n\nonBeforeMount(() => {\n  if (!shouldShowLoginPage.value) {\n    done();\n  }\n});\n</script>\n\n<style lang=\"scss\" scoped>\n.passwordless {\n  display: flex;\n  align-items: center;\n}\n\n.login {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  height: 100vh;\n}\n\n.loading {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 100vh;\n}\n</style>\n"],"names":["state","ref","validateEmail","email","isEmailValid","isEmail","interval","collectInfo","isResend","authorManager","updateEmailToLowerCase","value","collectToken","user","Tracking","emits","notifyResendToken","resendToken","restartAuth","router","useRouter","route","useRoute","done","redirectUrl","prevRedirectUrl","status","AuthorAPI","redirectPath","shouldShowLoginPage","computed","onBeforeMount"],"mappings":"qhCAwGA,MAAMA,EAAQC,EAAe,CAC3B,MAAO,eACP,KAAM,CAAE,MAAO,EAAA,EACf,MAAO,GACP,QAAS,GACT,kBAAmB,CAAA,CACpB,EAED,SAASC,GAAyB,CAChC,MAAMC,EAAQH,EAAM,MAAM,KAAK,MACzBI,EAAeC,EAAQF,CAAK,EAElC,OAAAH,EAAM,MAAM,QAAU,CAACI,EAChBA,CACT,CAEA,IAAIE,EACJ,MAAMC,EAAc,MAAO,CAAE,SAAAC,CAAA,EAAqC,CAAA,IAAO,CACvE,GAAKN,IAIL,CAAAF,EAAM,MAAM,MAAQ,UAEpB,GAAI,CACF,MAAMS,EAAc,aAAaT,EAAM,MAAM,KAAK,MAAOQ,CAAQ,EACjER,EAAM,MAAM,MAAQ,gBACpBA,EAAM,MAAM,kBAAoB,IAChC,cAAcM,CAAQ,EACtBA,EAAW,YAAY,IAAM,CAC3BN,EAAM,MAAM,mBAAqB,EAC7BA,EAAM,MAAM,mBAAqB,GACnC,cAAcM,CAAQ,CAE1B,EAAG,GAAI,CACT,MAAgB,CACdN,EAAM,MAAM,QAAU,GACtBA,EAAM,MAAM,MAAQ,cACtB,EACF,EAEMU,EAA0BC,GAAmB,CACjD,GAAI,CAACA,EAAO,CACVX,EAAM,MAAM,KAAK,MAAQ,GACzB,MACF,CACAA,EAAM,MAAM,KAAK,MAAQW,EAAM,YAAA,CACjC,EAEMC,EAAe,SAAY,CAC/B,GAAKZ,EAAM,MAAM,MAAM,MACvB,CAAAA,EAAM,MAAM,MAAQ,UAEpB,GAAI,CACF,MAAMa,EAAO,MAAMJ,EAAc,OAAOT,EAAM,MAAM,KAAK,MAAOA,EAAM,MAAM,KAAK,EACjF,GAAI,CAACa,EAAM,MAAM,IAAI,MAAM,6CAA6C,EACxEC,EAAS,aAAA,EACTC,EAAM,OAAQF,CAAI,EAClBb,EAAM,MAAM,MAAQ,MACtB,MAAY,CACVA,EAAM,MAAM,QAAU,GACtBA,EAAM,MAAM,MAAQ,eACtB,EACF,EAEMgB,EAAoB,MAAOb,GAAkB,CACjD,MAAM,MAAM,mEAAmEA,CAAK,GAAI,CACtF,OAAQ,KAAA,CACT,CACH,EAEMc,EAAc,IAAM,CACpBjB,EAAM,MAAM,OACdO,EAAY,CAAE,SAAU,GAAM,EAC9BS,EAAkBhB,EAAM,MAAM,KAAK,KAAK,EAE5C,EAEMkB,EAAc,IAAM,CACxBlB,EAAM,MAAM,MAAQ,eACpBA,EAAM,MAAM,KAAO,CAAE,MAAO,EAAA,EAC5BA,EAAM,MAAM,MAAQ,GACpBA,EAAM,MAAM,QAAU,EACxB,+lEC1KA,MAAMmB,EAASC,EAAA,EACTC,EAAQC,EAAA,EAEd,eAAeC,GAAO,CACpB,MAAMC,EAAcH,EAAM,MAAM,SAC1BI,EAAkBJ,EAAM,MAAM,eAAe,EAE7C,CAAE,OAAAK,CAAA,EAAW,MAAMC,EAAU,QAAA,EAEnC,GAAID,IAAW,SAAU,CACvBP,EAAO,KAAK,CACV,KAAM,aACN,MAAO,CACL,SAAUK,EACV,gBAAiBC,CAAA,CACnB,CACD,EACD,MACF,CAEA,GAAID,EAAa,CACf,MAAMI,EAAeJ,EAAY,MAAM,GAAG,EAAE,GAAG,EAAE,EACjD,MAAML,EAAO,KAAK,CAChB,KAAMS,EACN,MAAO,CACL,GAAGP,EAAM,MACT,SAAUI,EACV,gBAAiB,MAAA,CACnB,CACD,EACD,MACF,CAEAN,EAAO,KAAK,CAAE,KAAM,MAAA,CAAQ,CAC9B,CAEA,MAAMU,EAAsBC,EAAS,IAC5B,CAACrB,EAAc,UAAA,CACvB,EAED,OAAAsB,EAAc,IAAM,CACbF,EAAoB,OACvBN,EAAA,CAEJ,CAAC"}