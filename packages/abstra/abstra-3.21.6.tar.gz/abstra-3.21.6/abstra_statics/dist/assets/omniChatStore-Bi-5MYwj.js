import{C as w}from"./router-D5wfdag3.js";import{d as x,k as m,e as v,l as y,m as f,n as $,p as H,q as p,s as F,r as d,B as S,G as I,D as b,$ as L,V as O,E as B,ap as P,g as Z,bR as D,aV as N,aK as R,j as U,x as A}from"./jwt-decode.esm-Dca5fHH5.js";import{P as j}from"./record-BZIfMWML.js";import{u as _}from"./uuid-CK8Ke_G7.js";import{I as q}from"./PhCopySimple.vue-C9uB_c9T.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[e]="1ddd9765-a591-4ac1-a6cf-2e7b516ba92d",i._sentryDebugIdIdentifier="sentry-dbid-1ddd9765-a591-4ac1-a6cf-2e7b516ba92d")}catch{}})();const J=["width","height","fill","transform"],V={key:0},z=p("path",{d:"M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"},null,-1),G=[z],K={key:1},Q=p("path",{d:"M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128Z",opacity:"0.2"},null,-1),W=p("path",{d:"M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"},null,-1),X=[Q,W],Y={key:2},ee=p("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"},null,-1),te=[ee],se={key:3},oe=p("path",{d:"M172.24,99.76a6,6,0,0,1,0,8.48l-56,56a6,6,0,0,1-8.48,0l-24-24a6,6,0,0,1,8.48-8.48L112,151.51l51.76-51.75A6,6,0,0,1,172.24,99.76ZM230,128A102,102,0,1,1,128,26,102.12,102.12,0,0,1,230,128Zm-12,0a90,90,0,1,0-90,90A90.1,90.1,0,0,0,218,128Z"},null,-1),re=[oe],ie={key:4},ae=p("path",{d:"M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"},null,-1),ne=[ae],le={key:5},ce=p("path",{d:"M170.83,101.17a4,4,0,0,1,0,5.66l-56,56a4,4,0,0,1-5.66,0l-24-24a4,4,0,0,1,5.66-5.66L112,154.34l53.17-53.17A4,4,0,0,1,170.83,101.17ZM228,128A100,100,0,1,1,128,28,100.11,100.11,0,0,1,228,128Zm-8,0a92,92,0,1,0-92,92A92.1,92.1,0,0,0,220,128Z"},null,-1),he=[ce],de={name:"PhCheckCircle"},ue=x({...de,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(i){const e=i,t=m("weight","regular"),s=m("size","1em"),o=m("color","currentColor"),n=m("mirrored",!1),a=v(()=>e.weight??t),g=v(()=>e.size??s),h=v(()=>e.color??o),u=v(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:n?"scale(-1, 1)":void 0);return(l,c)=>(f(),y("svg",F({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:g.value,height:g.value,fill:h.value,transform:u.value},l.$attrs),[$(l.$slots,"default"),a.value==="bold"?(f(),y("g",V,G)):a.value==="duotone"?(f(),y("g",K,X)):a.value==="fill"?(f(),y("g",Y,te)):a.value==="light"?(f(),y("g",se,re)):a.value==="regular"?(f(),y("g",ie,ne)):a.value==="thin"?(f(),y("g",le,he)):H("",!0)],16,J))}});class E{constructor(e,t){this.flag=e,this.acc=t,this.staging=""}staging}class ge extends E{constructor(){super("___JSON_MODE___",[])}reduceChar(e){try{this.staging+=e;const t=JSON.parse(this.staging);return this.acc.push(t),this.staging="",t}catch{return}}reduce(e){const t=[];for(const s of e){const o=this.reduceChar(s);o!==void 0&&t.push(o)}return t}}class fe extends E{constructor(){super("___TEXT_MODE___","")}reduce(e){return this.staging+=e,this.acc=this.staging,e}}class k{mode;modes=[new fe,new ge];staging="";chunkOnBuffer="";flagMap;flagPrefixes;constructor(){this.mode=this.modes[0],this.flagMap=new Map,this.flagPrefixes=new Set;for(const e of this.modes){this.flagMap.set(e.flag,e);for(let t=1;t<e.flag.length;t++)this.flagPrefixes.add(e.flag.slice(0,t))}}*reduce(e){for(const t of e){if(this.staging+=t,this.flagMap.has(this.staging)){this.mode=this.flagMap.get(this.staging),this.staging="";continue}if(!this.flagPrefixes.has(this.staging))for(;this.staging.length>0;){const s=this.staging[0];this.staging=this.staging.slice(1);const o=this.mode.reduce(s);if(o!==void 0&&(Array.isArray(o)?yield*o:yield o),this.flagPrefixes.has(this.staging))break}}}*reduceInChunks(e,t){let s="";for(const o of this.reduce(t))if(typeof o=="string")for(s+=o;s.length>=e;)yield s.slice(0,e),s=s.slice(e);else s.length>0&&(yield s,s=""),yield o;s.length>0&&(yield s)}}const M=300;class pe{_baseUrl="/_editor/api/ai";_headers={"Content-Type":"application/json"};async*sendMessage(e,t,s,o,n){const a={conversationId:e,content:t,context:s,humanApproval:n},g=await fetch(`${this._baseUrl}/stream`,{method:"POST",headers:this._headers,body:JSON.stringify(a)});if(!g.ok)throw new Error("Failed to send message");const h=g.body?.getReader();if(!h)throw new Error("No response body");const u=new k;for(;!o();){const l=await h.read();if(l.done)break;for(const c of u.reduceInChunks(M,new TextDecoder().decode(l.value)))yield c}}async deleteThread(e){if(!(await fetch(`${this._baseUrl}/thread/${e}`,{method:"DELETE",headers:this._headers})).ok)throw new Error("Failed to delete thread")}async abortStreaming(e){if(!(await fetch(`${this._baseUrl}/abort`,{method:"POST",headers:this._headers,body:JSON.stringify({langGraphThreadId:e})})).ok)throw new Error("Failed to abort streaming")}async getHistory(e,t){const s=await fetch(`${this._baseUrl}/history?limit=${e}&offset=${t}`,{method:"GET"});if(!s.ok)throw new Error("Failed to fetch history");return await s.json()}async vote(e,t,s,o){const n={vote:e,question:t,answer:s,context:o};await fetch(`${this._baseUrl}/vote`,{method:"POST",headers:this._headers,body:JSON.stringify(n)})}startConversation(){return new Promise((e,t)=>{fetch(`${this._baseUrl}/start-conversation`,{method:"POST",headers:this._headers}).then(s=>{if(!s.ok)throw new Error("Failed to start conversation");return s.json()}).then(s=>e(s)).catch(s=>t(s))})}}class ye{projectId;baseUrl;constructor(e){this.projectId=e,this.baseUrl=`projects/${e}`}startConversation(){throw new Error("Method not implemented.")}async*sendMessage(e,t,s,o,n){const a={conversationId:e,content:t,context:s,humanApproval:n},h=(await w.postRaw(`${this.baseUrl}/messages`,a)).body?.getReader();if(!h)throw new Error("No response body");const u=new k;for(;!o();){const l=await h.read();if(l.done)break;for(const c of u.reduceInChunks(M,new TextDecoder().decode(l.value)))yield c}}async abortStreaming(e){await w.post(`${this.baseUrl}/abort`,{langGraphThreadId:e})}async getHistory(e,t){const s={limit:`${e}`,offset:`${t}`};return await w.get(`${this.baseUrl}/history`,s)}async deleteThread(e){await w.delete(`${this.baseUrl}/threads/${e}`)}async vote(e,t,s,o){throw new Error("Method not implemented.")}}const ve=x({__name:"CopyButton",props:{textToCopy:{}},setup(i){const e=i,t=d(!1),s=()=>{navigator.clipboard.writeText(e.textToCopy),t.value=!0,setTimeout(()=>t.value=!1,2e3)},o=v(()=>t.value?"Copied!":"Copy to clipboard");return(n,a)=>(f(),S(b(B),null,{title:I(()=>[L(O(o.value),1)]),default:I(()=>[p("div",{class:"copy-button",onClick:s},[t.value?(f(),S(b(ue),{key:1,color:"#fff",size:"22"})):(f(),S(b(q),{key:0,color:"#fff",size:"22"}))])]),_:1}))}}),_e=P(ve,[["__scopeId","data-v-9f87bac2"]]);class T{_repository;conversationId;_input;_badgeState;_smartChatState;_logService;_stageId=null;_hasError=d(null);_isLoadingHistory=d(!1);_history=d([]);_threadHistoryFetchInfo=d({limit:10,offset:0,done:!1});_recentlyAccessedThreads=d([]);_environment;codeForApproval=d(null);constructor(e,t,s){this._repository=e,this._logService=t,this.conversationId=d(null),this._input=d(""),this._badgeState=d({type:"seen"}),this._smartChatState=d("idle"),this._environment=s}init(){this.setupThread(),this.renderCopyButtons(),this.fetchHistory()}setupThread=async()=>{this.conversationId.value=`abstra-assistant-thread-${_()}`,this._recentlyAccessedThreads.value.unshift({id:this.conversationId.value,messages:[],createdAt:new Date().toISOString()})};fetchHistory=async()=>{this._isLoadingHistory.value=!0;const e=await this._repository.getHistory(this._threadHistoryFetchInfo.value.limit,this._threadHistoryFetchInfo.value.offset);this._history.value=e,this._isLoadingHistory.value=!1};loadMoreHistory=async()=>{this._isLoadingHistory.value=!0,this._threadHistoryFetchInfo.value.offset+=this._threadHistoryFetchInfo.value.limit;const e=await this._repository.getHistory(this._threadHistoryFetchInfo.value.limit,this._threadHistoryFetchInfo.value.offset);e.length<this._threadHistoryFetchInfo.value.limit&&(this._threadHistoryFetchInfo.value.done=!0);const t=[...this._history.value,...e];this._history.value=t,this._isLoadingHistory.value=!1};setStageId=e=>{this._stageId=e};setError=e=>{this._hasError.value=e};get hasError(){return this._hasError.value?.payload||null}_fillChat=e=>{this._logService.clear();for(const t of e)t.toolTitle?(this._logService.log({type:"ai-tool-approval",toolCallId:t.toolCallId,description:t.toolTitle,args:{},disabled:!1,needsApproval:!1,loading:!1}),this._logService.log({type:"ai-tool-call-response",toolCallId:t.toolCallId,response:t.content})):this._logService.log({type:t.role==="user"?"ai-input":"ai-output",log:t.content});this.renderCopyButtons()};moveThreadFromHistoryToRecents=e=>{this.conversationId.value=e;const t=this._history.value.find(o=>o.id===e);if(!t)throw new Error(`Thread ${e} not found`);const s=this._recentlyAccessedThreads.value.findIndex(o=>o.id===e);s!==-1&&this._recentlyAccessedThreads.value.splice(s,1),this._recentlyAccessedThreads.value.unshift(t),this._fillChat(t.messages)};deleteThread=e=>{this._repository.deleteThread(e),this.removeFromRecentlyAccessedThreads(e);const t=this._history.value.findIndex(s=>s.id===e);t!==-1&&this._history.value.splice(t,1)};setCurrentThreadFromRecents=e=>{this.conversationId.value=e;const t=this._recentlyAccessedThreads.value.findIndex(o=>o.id===e);if(t===-1)throw new Error(`Thread ${e} not found`);const[s]=this._recentlyAccessedThreads.value.splice(t,1);this._recentlyAccessedThreads.value.unshift(s),this._fillChat(s.messages)};removeFromRecentlyAccessedThreads=e=>{const t=this._recentlyAccessedThreads.value.findIndex(s=>s.id===e);if(t===-1)throw new Error(`Thread ${e} not found`);if(this._recentlyAccessedThreads.value.splice(t,1),this._logService.clear(),this._recentlyAccessedThreads.value.length===0)this.conversationId.value=null;else{const s=this._recentlyAccessedThreads.value[0];this.conversationId.value=s.id,this._fillChat(s.messages)}};renderCopyButtons=()=>{document.querySelectorAll("pre").forEach(t=>{t.style.position="relative";const s=Z(_e,{textToCopy:t.textContent});D(s,t)})};clearLogService=()=>{this._logService.clear()};send=async(e,t)=>{this.conversationId.value||await this.setupThread(),this._logService.log({type:"ai-input",log:this._input.value}),this._smartChatState.value="processing";try{const s=_(),o=this.conversationId.value;if(!o)throw new Error("Conversation ID is not set");const n=[{type:"text",text:this._input.value}],a={currentEditorUrl:window.location.href,panesInfo:e||{}},g=this._repository.sendMessage(o,n,a,this.isIdle.bind(this),t);let h="",u=s,l="";for await(const c of g){if(this.isIdle())break;this._smartChatState.value==="processing"&&(this._smartChatState.value="answering");const r=c;typeof r=="string"?(h+=r,l+=r,this._logService.log({type:"ai-output",log:l},u)):r instanceof Object&&(r.type==="ai-tool-approval"?(this._logService.log({type:"ai-tool-approval",toolCallId:r.toolCallId,description:r.title,args:r.args,disabled:!1,needsApproval:!0,loading:!1}),r.args?.changes?.code_content&&(this.codeForApproval.value={stageId:r.args.id,code:r.args.changes.code_content}),u=_(),l=""):r.type==="ai-tool-call"?(this._logService.log({type:"ai-tool-approval",toolCallId:r.toolCallId,description:r.title,args:r.args,disabled:!1,needsApproval:!1,loading:!1}),u=_(),l=""):r.type==="ai-tool-call-response"&&this._logService.log({type:"ai-tool-call-response",toolCallId:r.toolCallId,response:r.response}))}this._recentlyAccessedThreads.value=this._recentlyAccessedThreads.value.map(c=>(c.id===this.conversationId.value&&c.messages.unshift({role:"assistant",content:h,createdAt:new Date().toISOString()}),c)),this._input.value=""}catch(s){this._logService.log({type:"ai-output",log:"Sorry, there was an issue processing your request. Please try again later."}),console.error(s),N(s)}finally{this._smartChatState.value="idle",this.renderCopyButtons()}};get logService(){return this._logService}shouldRenderLoadMoreHistory(){return!this._threadHistoryFetchInfo.value.done}get pastThreads(){return this._history.value.map(e=>e.messages.length===0?{threadId:e.id,title:"New thread"}:{threadId:e.id,title:e.messages[0].content.slice(0,20)+"..."})}get recentlyAccessedThreads(){return this._recentlyAccessedThreads.value.map(e=>({threadId:e.id,title:e.messages.length>0?e.messages[0].content.slice(0,20)+"...":"New thread"}))}abort=()=>{if(!this.conversationId.value)throw new Error("Conversation ID is not set");this._repository.abortStreaming(this.conversationId.value),this._smartChatState.value="idle"};isLoadingHistory=()=>this._isLoadingHistory.value;isProcessing=()=>this._smartChatState.value==="processing";isAnswering=()=>this._smartChatState.value==="answering";isIdle=()=>this._smartChatState.value==="idle";setSeen=()=>{this._badgeState.value={type:"seen"}};setUnseen=e=>{this._badgeState.value={type:"unseen",count:this._badgeState.value.type==="unseen"?this._badgeState.value.count+1:1,severity:e.type==="stderr"?"error":"info"}};setInput=e=>{e=e?.trimEnd(),this._input.value=e||""};regenerateLast=async()=>{for(let e=this._logService.logs.length-1;e>=0;e--){const t=this._logService.logs[e];if(t.type==="ai-input"){this.setInput(t.log);break}}await this.send()};get badgeState(){return this._badgeState.value}get input(){return this._input.value}fixJson=async(e,t)=>{this._logService.clear(),this._logService.log({type:"ai-input",log:`here is my json code:
      ${e}
      And I got this error:`}),this._logService.log({type:"stderr",log:t}),this.setSeen(),this.setInput("Can you fix this JSON?"),await this.send()};askAboutError=async(e,t)=>{this._logService.clear(),this.setInput(`I have this error in my code:
      ${e.entries.map(s=>s.payload.text).join("")}

      Can you help me understand what went wrong?
      My current code is: ${t||"No code provided"}`),await this.send()};vote=async(e,t)=>{const s=this._logService.logs[e],o=this._logService.logs[e-1],n=this._logService.logs.slice(0,e-1);await this._repository.vote(t,o,s,n)}}class C{logState=R({log:[]});_listeners={};static create(){return new C}get logs(){return this.logState.log}hasAiLogs(){return this.logs.some(e=>e.type==="ai-input"||e.type==="ai-output")}log(e,t){if(e.type!=="restart"&&e.type!=="ai-actions"&&e.type!=="ai-tool-approval"&&e.type!=="ai-tool-call-response"&&"log"in e&&e.log.trim()==="")return;const s=t?this.logs.find(o=>o.id===t):null;return s?(s.type==="stderr"&&e.type==="stderr"&&(e.log=s.log+`
`+e.log),Object.assign(s,e)):this.logs.push({...e,id:t||_()}),this.notifyListeners(e),t}clear(){this.logState.log=[]}listen(e){const t=_();return this._listeners[t]=e,t}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(t=>t(e))}getLastExecutionLogs=e=>{let t="";for(let s=this.logs.length-1;s>=0;s--){const o=this.logs[s];if(o.type!==e&&t.length>0)break;o.type===e&&(t=`${o.log}
${t}`)}return t}}const Ie=new j,Ae=U("omniChat",()=>{const i=d(!0),e=d(!1),t=C.create(),s=A(),o=A(),n=(c,r)=>{if(!o.value)if(c==="console"){if(!r)throw new Error("Project ID is required for console chat");s.value=new ye(r),o.value=new T(s.value,t,{origin:c,projectId:r})}else s.value=new pe,o.value=new T(s.value,t,{origin:c})},a=()=>{e.value=!0},g=()=>{e.value=!1},h=()=>{i.value=!0,a()},u=()=>{i.value=!1,g()};return{isOpen:i,isInputFocused:e,focusInput:a,blurInput:g,open:h,close:u,toggle:()=>{i.value?u():h()},controller:v(()=>o.value),repository:s,init:n}});export{ue as H,pe as L,T as S,C as a,Ie as o,Ae as u};
//# sourceMappingURL=omniChatStore-Bi-5MYwj.js.map
