import{ap as z,r as f,aQ as L,aR as J,D as F,ao as U,ak as P,ag as R,ah as I,O as G,aS as X,H as W,aB as j,l as M,aT as $,aU as B,aV as H,aM as Q,aW as Y,aF as Z,j as A,aX as K,aY as q,aZ as ee}from"./index.Dc_WcSRe.js";import{w as te,E as ne}from"./withFullScreenWrapper.DJ88R0i7.js";import{S as k,T as se}from"./Toolbar.D2sz8rKn.js";import{u as re}from"./FormClearHelper.DgvKxH31.js";const ae=20;function oe(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&F(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const ce=(n,t,o,s,c,l,i,p)=>{const e=JSON.parse(n);if(o==="streamlit"?e.config=L(e.config,c):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=L(e.config,c),e.usermeta.embedOptions.theme=void 0):e.config=J(e.config,c),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(i-40,0)),l?(e.width=i,e.height=p,"vconcat"in e&&e.vconcat.forEach(u=>{u.width=i})):t&&(e.width=i,"vconcat"in e&&e.vconcat.forEach(u=>{u.width=i})),e.padding||(e.padding={}),F(e.padding.bottom)&&(e.padding.bottom=ae),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return s.length>0&&oe(e),e},ie=(n,t,o,s)=>{const c=z(),{id:l,formId:i,spec:p,data:e,datasets:u,useContainerWidth:a,vegaLiteTheme:d,selectionMode:r}=n,g=f.useMemo(()=>r,[JSON.stringify(r)]),S=f.useMemo(()=>ce(p,a,d,g,c,t,o||0,s),[p,a,d,g,c,t,o,s]);return{id:l,formId:i,vegaLiteTheme:d,spec:S,selectionMode:g,data:e,datasets:u,useContainerWidth:a}},le={DATAFRAME_INDEX:"(index)"};function ue(n){return!n||n.dimensions.numDataRows===0?null:D(n)}function fe(n){const t=x(n);if(F(t))return null;const o={};for(const[s,c]of Object.entries(t))o[s]=D(c);return o}function x(n){if(n?.length===0)return null;const t={};return n.forEach(o=>{if(!o)return;const s=o.hasName?o.name:null;t[s]=o.data}),t}function D(n,t=0){if(n.dimensions.numDataRows===0)return[];const o=[],{numDataRows:s,numDataColumns:c,numIndexColumns:l}=n.dimensions,i=n.columnTypes[0]??void 0,p=i&&i.type===U.INDEX&&(P(i)||R(i)||I(i));for(let e=t;e<s;e++){const u={};if(p){const{content:a}=n.getCell(e,0);u[le.DATAFRAME_INDEX]=typeof a=="bigint"?Number(a):a}for(let a=0;a<c;a++){const d=a+l,{content:r,contentType:g}=n.getCell(e,d);if((r instanceof Date||typeof r=="number"&&Number.isFinite(r))&&(R(g)||I(g))&&!G(g)){const S=new Date(r).getTimezoneOffset()*60*1e3;u[n.columnNames[0][d]]=r.valueOf()+S}else u[n.columnNames[0][d]]=typeof r=="bigint"?Number(r):r}o.push(u)}return o}const de=150,me=M.getLogger("useVegaLiteSelections"),pe=(n,t,o)=>{const{id:s,formId:c,selectionMode:l}=n,i=f.useCallback(e=>{l.forEach(a=>{e.addSignalListener(a,X(de,(d,r)=>{const g=e.getState({data:(y,C)=>l.some(w=>`${w}_store`===y),recurse:!1});W(g)&&t.setElementState(s,"viewState",g);let S=r;"vlPoint"in r&&"or"in r.vlPoint&&(S=r.vlPoint.or);const E={id:s,formId:c},m=JSON.parse(t.getStringValue(E)||"{}"),h={selection:{...m?.selection||{},[d]:S||{}}};j(m,h)||t.setStringValue(E,JSON.stringify(h),{fromUi:!0},o)}))});const u=t.getElementState(s,"viewState");if(W(u))try{return e.setState(u)}catch(a){me.warn("Failed to restore view state",a)}return e},[s,l,t,c,o]),p=f.useCallback(()=>{const e={selection:{}};l.forEach(r=>{e.selection[r]={}});const u={id:s,formId:c},a=t.getStringValue(u),d=a?JSON.parse(a):e;j(d,e)||t.setStringValue(u,JSON.stringify(e),{fromUi:!0},o)},[s,c,o,l,t]);return{maybeConfigureSelections:i,onFormCleared:p}},v="source",ge=M.getLogger("useVegaEmbed");function he(n,t,o){const s=f.useRef(null),c=f.useRef(null),l=f.useRef(v),i=f.useRef(null),p=f.useRef([]),{maybeConfigureSelections:e,onFormCleared:u}=pe(n,t,o);re({widgetMgr:t,element:n,onFormCleared:u});const{data:a,datasets:d}=n;f.useEffect(()=>{s.current===null&&(i.current=a,p.current=d)},[a,d]);const r=f.useCallback(()=>{c.current&&c.current(),c.current=null,s.current=null},[]),g=f.useCallback(async(m,h)=>{if(m.current===null)throw new Error("Element missing.");r();const y={ast:!0,expr:B,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:C,view:w,finalize:V}=await $(m.current,h,y);s.current=e(w),c.current=V;const b=fe(p.current),O=b?Object.keys(b):[];if(O.length===1){const[T]=O;l.current=T}else O.length===0&&C.data&&(l.current=v);const N=ue(i.current);if(N&&s.current.insert(l.current,N),b)for(const[T,_]of Object.entries(b))s.current.insert(T,_);return await s.current.runAsync(),await s.current.resize().runAsync(),s.current},[r,e]),S=f.useCallback((m,h,y,C)=>{if(!C||C.dimensions.numDataRows===0){try{m.remove(h,H)}finally{}return}if(!y||y.dimensions.numDataRows===0){m.insert(h,D(C));return}C.hash!==y.hash&&(m.data(h,D(C)),ge.info(`Had to clear the ${h} dataset before inserting data through Vega view.`))},[]),E=f.useCallback(async(m,h)=>{if(s.current===null)return null;const y=i.current,C=p.current;(y||m)&&S(s.current,l.current,y,m);const w=x(C)??{},V=x(h)??{};for(const[b,O]of Object.entries(V)){const N=b||l.current,T=w[N];S(s.current,N,T,O)}for(const b of Object.keys(w))!Object.hasOwn(V,b)&&b!==l.current&&S(s.current,b,null,null);return await s.current?.resize().runAsync(),i.current=m,p.current=h,s.current},[S]);return{createView:g,updateView:E,finalizeView:r}}function Se(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const ye=({disableFullscreenMode:n,element:t,fragmentId:o,widgetMgr:s})=>{const{expanded:c,height:l,width:i,expand:p,collapse:e}=Q(ne),[u,a]=Y(),d=Se(t.spec),r=ie(t,c,d?i??0:u,l??0),{createView:g,updateView:S,finalizeView:E}=he(r,s,o),{data:m,datasets:h,spec:y}=r;return f.useLayoutEffect(()=>(a.current!==null&&g(a,y),E),[g,E,y,i,l,a]),f.useEffect(()=>{S(m,h)},[m,h,S]),Z(k,{height:l,useContainerWidth:r.useContainerWidth,children:[A(se,{target:k,isFullScreen:c,onExpand:p,onCollapse:e,disableFullscreenMode:n}),A(q,{styles:[K]}),A(ee,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:r.useContainerWidth,isFullScreen:c,ref:a})]})},Ce=te(ye),Ne=f.memo(Ce);export{K as StyledVegaLiteChartTooltips,L as applyStreamlitTheme,Ne as default};
