name: Delete next branch after merge

permissions:
  contents: write

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  delete-next-branch:
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'next'
    runs-on: self-hosted
    steps:
      - name: Ensure gh CLI is installed
        run: |
          if ! command -v gh &> /dev/null; then
            echo "gh not found, installing..."
            if [[ "$RUNNER_OS" == "Linux" ]]; then
              type -p curl >/dev/null || sudo apt-get install curl -y
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
              sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
              sudo apt-get update
              sudo apt-get install gh -y
            elif [[ "$RUNNER_OS" == "macOS" ]]; then
              brew install gh
            else
              echo "Unsupported OS for automatic gh install" && exit 1
            fi
          else
            echo "gh is already installed"
          fi

      - name: Delete next branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X DELETE \
            "repos/${{ github.repository }}/git/refs/heads/next"
