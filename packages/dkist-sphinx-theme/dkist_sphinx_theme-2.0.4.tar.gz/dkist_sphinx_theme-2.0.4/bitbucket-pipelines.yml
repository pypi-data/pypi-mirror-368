image: python:3.10

definitions:
  steps:
    - step: &download_execute_script
        name: Download Script Execute Script
        script:
          - echo "Retrieving Script Execution Script"
          - curl -fL https://getcli.jfrog.io | sh
          - ./jfrog rt dl --url $ARTIFACTORY_URL --user $ARTIFACTORY_USER --password $ARTIFACTORY_PASSWORD generic-packages/ci_scripts/latest/execute_script.sh
          - cat ci_scripts/latest/execute_script.sh
          - chmod 755 ci_scripts/latest/execute_script.sh
        artifacts:
          - ci_scripts/latest/execute_script.sh

pipelines:
  default:
    - step: *download_execute_script
    - step:
        caches:
          - pip
        name: Test
        script:
          - pip install .[test]
          - pytest -v --cov src --cov-report xml:coverage.xml --cov-report term-missing
          - ./ci_scripts/latest/execute_script.sh upload_coverage.sh

    - step:
        name: Twine check
        script:
          - python --version
          - pip install -U --force-reinstall twine build
          - python -m build
          - python -m twine check dist/*

  tags:
    'v*':
      - step: *download_execute_script
      - step:
          name: Push to PyPi
          script:
            - ./ci_scripts/latest/execute_script.sh push_python.sh