# GitHub Actions Workflow: Test, Build, and Release Python Package
#
# This workflow is triggered on every push of a tag that starts with 'v'.
# It runs tests, builds the package, and then creates a GitHub Release,
# attaching the built package files as release assets.

name: Test, Build, and Release Python Package

# Controls when the workflow will run.
# Triggers the workflow on pushes to tags like v1.0, v2.1.3, etc.
on:
  push:
    tags:
      - 'v*'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel.
jobs:
  # This job runs the test suite.
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          # If you have a requirements.txt file, uncomment the following line:
          # pip install -r requirements.txt
          # Or install the package itself in editable mode to get dependencies
          pip install -e .

      - name: Run tests
        run: pytest

  # This job builds the package. It will only run if the 'test' job completes successfully.
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: python -m build

      # This step uploads the built package files so the 'release' job can use them.
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

  # This job creates a GitHub Release and uploads the package. It runs only if 'build' succeeds.
  release:
    needs: build
    runs-on: ubuntu-latest
    # This job needs permissions to write to the repository's contents to create a release.
    permissions:
      contents: write
    steps:
      # This step downloads the files that were built in the 'build' job.
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      # This step creates a GitHub Release and uploads the built packages from the 'dist'
      # directory as release assets. It automatically uses the tag that triggered the workflow.
      - name: Create GitHub Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          # This will upload all files from the dist/ directory to the release.
          files: dist/*
